<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Sistema de Captura de Notas de Radio</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <style>
    /* Importaci√≥n de Google Fonts para Roboto */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    /* --- PALETA DE COLORES ACTUALIZADA (Rojo, Blanco, Negro) --- */
    :root {
      --color-fondo-pagina: #1E1E1E;       /* Negro Oscuro (Fondo Principal) */
      --color-fondo-form: #2C2C2C;         /* Gris Oscuro (Fondo del Formulario/Tabla) */
      --color-primary: #D20A11;            /* Rojo Vivo (Bot√≥n Guardar/Encabezado Tabla) */
      --color-primary-hover: #AA080C;      /* Rojo Oscuro (Hover) */
      --color-secondary: #D20A11;          /* Rojo Vivo (Bot√≥n Limpiar/Iconos) */
      --color-secondary-hover: #AA080C;    /* Rojo Oscuro (Hover) */
      --color-danger: #AA080C;             /* Rojo para advertencias/eliminar */
      --color-danger-hover: #D20A11;       /* Rojo Vivo */
      --color-telegram: #0088cc;           
      --color-telegram-hover: #0077b3;     
      --color-dark-text: #1E1E1E;          /* Texto para inputs (fondo claro) */
      --color-light-text: #FFFFFF;         /* Texto principal (fondo oscuro) */
      --color-input-bg: #FFFFFF;           /* Fondo de los campos de texto: Blanco */
      --color-alerta-vacio: #FFD700;       
      --radius: 0.25rem;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    header img {
      height: 50px;
      width: auto;
    }
    
    /* --- FORMULARIO --- */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-logo-container {
        grid-column: span 4; 
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-secondary);
    }
    .form-logo-container img {
        height: 80px; 
        width: auto; 
        opacity: 0.9;
    }
    label {
        font-weight: 700;
        align-self: center;
        color: var(--color-light-text);
    }
    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }
    .campo > input[type="text"], 
    .campo > input[type="date"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .campo > input[type="text"]:focus,
    .campo > input[type="date"]:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(210, 10, 17, 0.25);
        outline: none;
    }
    /* El campo Titular (tercer par) pasa a ocupar todo el ancho */
    form > label:nth-child(8), 
    form > div:nth-child(9) { 
        grid-column: span 4;
    }
    
    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      color: var(--color-dark-text);
    }
    .sugerencia { padding: 8px 10px; cursor: pointer; }
    .sugerencia:hover, .sugerencia.resaltado { background-color: #f0f0f0; color: var(--color-dark-text); }
    
    /* --- BLOQUEO --- */
    .bloqueado { background-color: #e9e9e9 !important; border: 1px solid var(--color-primary-hover) !important; cursor: not-allowed; }
    input:required:invalid { border-left: 5px solid var(--color-danger); }
    input:required:valid { border-left: 5px solid #28a745; }
    
    /* --- BOTONES --- */
    .button-group-form {
        grid-column: span 4;
        display: flex;
        gap: 15px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }
    #btnGuardar { background-color: var(--color-primary); }
    #btnGuardar:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }
    #btnLimpiar { background-color: var(--color-secondary); }
    #btnLimpiar:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
    #btnEliminar { background-color: var(--color-danger); }
    #btnEliminar:hover { background-color: var(--color-danger-hover); transform: translateY(-1px); }
    
    .campo button[type="button"] { background-color: var(--color-secondary); padding: 8px; margin-right: 0; }
    .campo button[type="button"]:hover { background-color: var(--color-secondary-hover); }
    
    button i { margin-right: 8px; font-size: 1.1em; }
    
    /* Eliminar el margin del icono para los botones peque√±os dentro del campo */
    .campo button i {
        margin-right: 0; 
    }
    
    /* --- ESTILOS PARA SUGERENCIA DE TEMA y ACCIONES GLOBALES (NUEVO) --- */
    .sugerencia-y-acciones {
        max-width: 900px;
        margin: 0 auto 30px auto;
        padding: 0 25px;
        display: flex;
        flex-direction: column; 
        gap: 15px;
    }
    .sugerencia-grupo {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
    }
    #inputSugerenciaTema {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box;
    }
    #btnSugerirTema {
        background-color: #38C71B; /* Verde para diferenciar */
        white-space: nowrap;
    }
    #btnSugerirTema:hover {
        background-color: #2F9C16;
        transform: translateY(-1px);
    }
    
    /* GRUPO DE ACCIONES GLOBALES */
    .actions-group {
        display: flex;
        gap: 15px;
        margin-top: 0; /* Ajustado */
        margin-bottom: 0; /* Ajustado */
        justify-content: flex-start;
        align-items: center;
        flex-wrap: wrap; /* Permitir que los botones se envuelvan */
    }
    #btnExportar { background-color: #4A4A4A; } 
    #btnExportar:hover { background-color: #616161; }
    
    #btnTelegram { background-color: var(--color-telegram); }
    #btnTelegram:hover { background-color: var(--color-telegram-hover); }

    #btnBorrarTodo { background-color: var(--color-primary); }
    #btnBorrarTodo:hover { background-color: var(--color-primary-hover); transform: translateY(-1px); }

    /* --- TABLA --- */
    h2 {
        margin-top: 40px;
        color: var(--color-light-text);
        border-bottom: 1px solid var(--color-secondary);
        padding-bottom: 5px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      background-color: var(--color-fondo-form);
    }
    
    th, td {
      padding: 12px 15px;
      border: 1px solid #3A3A3A;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
      max-width: 180px; 
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis; 
    }
    
    #tablaNotas th[data-col="titular"], #tablaNotas td:nth-child(5) {
        max-width: 250px; 
    }
    #tablaNotas th:last-child, #tablaNotas td:last-child {
        max-width: 100px;
        min-width: 100px;
        white-space: nowrap;
        overflow: visible;
        text-overflow: clip; 
    }
    
    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }
    tbody tr:nth-child(even) { background-color: #353535; } 
    .editando { background-color: var(--color-primary-hover) !important; color: var(--color-light-text); }
    .editando td { color: var(--color-light-text); }
    .alerta-vacio { background-color: var(--color-alerta-vacio) !important; color: var(--color-dark-text) !important; }
    .alerta-vacio td { color: var(--color-dark-text) !important; }
    
    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    /* --- SORTING --- */
    .sortable-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .sort-icon { margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
    .sorted .sort-icon { opacity: 1; color: var(--color-light-text); }
    .sorted.alerta-vacio .sort-icon { color: var(--color-dark-text); }
    
    /* Bot√≥n Editar en Tabla */
    .btn-accion-tabla {
        padding: 8px 12px;
        background-color: var(--color-secondary); 
        color: var(--color-light-text); 
    }
    .btn-accion-tabla:hover { background-color: var(--color-secondary-hover); }

    /* --- ESTILOS DEL BUSCADOR --- */
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      padding: 0 25px;
    }
    
    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px; 
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box; 
      transition: all 0.2s ease;
    }

    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(210, 10, 17, 0.25);
    }

    .buscador-icon {
      position: absolute;
      left: 37px; /* Ajuste para el padding del contenedor */
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        body { padding: 10px; }
        header { flex-direction: column; align-items: flex-start; padding: 10px; }
        form { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
        form > label, form > div, .form-logo-container { grid-column: span 1 !important; }
        .button-group-form { justify-content: space-around; }
        .button-group-form button { width: 32%; margin-right: 0; }
        
        .sugerencia-y-acciones { padding: 0 10px; }
        .sugerencia-grupo { flex-direction: column; align-items: stretch; }
        .sugerencia-grupo button { width: 100%; }
        
        /* Ajuste para actions-group en responsive */
        .actions-group { flex-direction: column; align-items: stretch; gap: 10px; }
        .actions-group button { width: 100%; margin-bottom: 0; }
        
        .buscador-container { padding: 0 10px; }
        .buscador-icon { left: 22px; }

        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        tr { border: 1px solid #3A3A3A; margin-bottom: 10px; }
        td { 
            border: none;
            border-bottom: 1px solid #4A4A4A;
            position: relative;
            padding-left: 50%;
            text-align: right;
            font-size: 0.9em;
            color: var(--color-light-text);
            max-width: 100% !important; 
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }
        td:before { 
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%; 
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
        }
        td:last-child { text-align: center; padding-left: 10px; }
        .alerta-vacio td { color: var(--color-dark-text) !important; }
    }
  </style>
</head>
<body>
  <header>
    <img src="./logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas de Radio</h1>
  </header>

  <form>
    <div class="form-logo-container">
        <img src="./logo.png" alt="Logotipo del Formulario">
    </div>

    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
      <label for="checkUsuario">üîí</label>
    </div>
    
    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
      <label for="checkFecha">üîí</label>
    </div>

    <label for="radiodifusora">Radiodifusora:</label>
    <div class="campo">
      <input type="text" id="radiodifusora" name="radiodifusora" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('radiodifusora','sugRadiodifusora')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkRadiodifusora" onchange="alternarBloqueo('radiodifusora')" tabindex="-1">
      <label for="checkRadiodifusora">üîí</label>
      <div id="sugRadiodifusora" class="sugerencias"></div>
    </div>

    <label for="titular">Titular:</label>
    <div class="campo">
      <input type="text" id="titular" name="titular" required>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
      <label for="checkTitular">üîí</label>
    </div>

    <label for="autor">Autor:</label>
    <div class="campo">
      <input type="text" id="autor" name="autor" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('autor','sugAutor')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkAutor" onchange="alternarBloqueo('autor')" tabindex="-1">
      <label for="checkAutor">üîí</label>
      <div id="sugAutor" class="sugerencias"></div>
    </div>

    <label for="programa">Programa:</label>
    <div class="campo">
      <input type="text" id="programa" name="programa" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('programa','sugPrograma')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkPrograma" onchange="alternarBloqueo('programa')" tabindex="-1">
      <label for="checkPrograma">üîí</label>
      <div id="sugPrograma" class="sugerencias"></div>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
      <label for="checkDependencia">üîí</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>

    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
      <label for="checkOrganismo">üîí</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>

    <label for="genero">G√©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
      <label for="checkGenero">üîí</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>

    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
      <label for="checkCanal">üîí</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>

    <label for="tema">Tema:</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      
      
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
      <label for="checkTema">üîí</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>

    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
      <label for="checkEstatus">üîí</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">üîΩ</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
      <label for="checkMunicipio">üîí</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>

    <div class="button-group-form">
      <button type="submit" id="btnGuardar">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>

      <button type="button" id="btnEliminar" style="display: none;" onclick="borrarNota()">
        <i class="fa-solid fa-trash-can"></i> Borrar Nota
      </button>

      <button type="reset" id="btnLimpiar">
        <i class="fa-solid fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="sugerencia-y-acciones">
    <div class="sugerencia-grupo">
        <input type="text" id="inputSugerenciaTema" placeholder="Escribe aqu√≠ tu sugerencia de tema">
        <button id="btnSugerirTema" onclick="enviarSugerenciaTema()">
          <i class="fa-solid fa-lightbulb"></i> Sugerir Tema
        </button>
    </div>
    <div id="mensajeSugerencia" style="color: yellow; font-weight: bold; font-size: 0.9em; margin-top: -10px;"></div>
    
    <div class="actions-group">
      <button id="btnExportar" onclick="exportarCSV()">
        <i class="fa-solid fa-file-csv"></i> Exportar CSV
      </button>
      <button id="btnTelegram" onclick="enviarTelegram()">
        <i class="fa-brands fa-telegram"></i> Enviar por Telegram
      </button>
      <button id="btnBorrarTodo" onclick="borrarTodasLasNotas()">
        <i class="fa-solid fa-eraser"></i> Borrar Todas
      </button>
    </div>
  </div>

  <div class="buscador-container">
      <span class="buscador-icon"><i class="fa-solid fa-magnifying-glass"></i></span>
      <input type="text" id="buscador" placeholder="Buscar por palabra clave...">
  </div>

  <h2>Notas Capturadas</h2>
  <table id="tablaNotas">
      <thead>
        <tr>
          <th data-col="ordenCaptura" style="min-width: 50px;">
            <div class="sortable-header">#<span class="sort-icon"></span></div>
          </th>
          <th data-col="usuario">
            <div class="sortable-header">Usuario<span class="sort-icon"></span></div>
          </th>
          <th data-col="fecha" style="min-width: 100px;">
            <div class="sortable-header">Fecha<span class="sort-icon"></span></div>
          </th>
          <th data-col="radiodifusora">
            <div class="sortable-header">Radiodifusora<span class="sort-icon"></span></div>
          </th>
          <th data-col="titular">
            <div class="sortable-header">Titular<span class="sort-icon"></span></div>
          </th>
          <th data-col="autor">
            <div class="sortable-header">Autor<span class="sort-icon"></span></div>
          </th>
          <th data-col="programa">
            <div class="sortable-header">Programa<span class="sort-icon"></span></div>
          </th>
          <th data-col="dependencia">
            <div class="sortable-header">Dependencia<span class="sort-icon"></span></div>
          </th>
          <th data-col="organismo">
            <div class="sortable-header">Organismo<span class="sort-icon"></span></div>
          </th>
          <th data-col="genero">
            <div class="sortable-header">G√©nero<span class="sort-icon"></span></div>
          </th>
          <th data-col="canal">
            <div class="sortable-header">Canal<span class="sort-icon"></span></div>
          </th>
          <th data-col="tema">
            <div class="sortable-header">Tema<span class="sort-icon"></span></div>
          </th>
          <th data-col="estatus">
            <div class="sortable-header">Estatus<span class="sort-icon"></span></div>
          </th>
          <th data-col="municipio">
            <div class="sortable-header">Municipio<span class="sort-icon"></span></div>
          </th>
          <th data-col="acciones">Acciones</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
  </table>

  <script>
    // --- VARIABLES GLOBALES ---
    const camposDeDatos = [
      "ordenCaptura", "usuario", "fecha", "radiodifusora", "titular", "autor", "programa",
      "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"
    ];
    let notas = [];
    let nextOrdenCaptura = 1; 
    let filaEnEdicion = null;
    const encabezadosTabla = {
      "ordenCaptura": "#",
      "usuario": "Usuario",
      "fecha": "Fecha",
      "radiodifusora": "Radiodifusora",
      "titular": "Titular",
      "autor": "Autor",
      "programa": "Programa",
      "dependencia": "Dependencia",
      "organismo": "Organismo",
      "genero": "G√©nero",
      "canal": "Canal",
      "tema": "Tema",
      "estatus": "Estatus",
      "municipio": "Municipio",
      "acciones": "Acciones"
    };
    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' };

    // RUTAS RELATIVAS (Aseg√∫rate de que estos archivos CSV existan en la misma carpeta)
    const urls = {
      dependencias: "./Dependencia.csv",
      radiodifusoras: "./Radiodifusora.csv",
      generos: "./Genero.csv",
      estatus: "./Estatus.csv",
      temas: "./Tema.csv",
      municipios: "./Municipio.csv",
      autores: "./Autor.csv"
    };

    // RUTA DE DESPLIEGUE DE TU GOOGLE APPS SCRIPT
    // *** ESTA ES LA URL PROPORCIONADA POR TI PARA LA PRUEBA ***
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxXNixPwsyFiLoC55-u3p5Z1rT1rWX03_alTk3XwDmgjq6t3W5-fjR-Fs3IF_y5wGI/exec";

    // CONFIGURACI√ìN TELEGRAM
    const TELEGRAM_BOT_TOKEN = "8428524335:AAFeKrvKrXxrI9NAkL_G1-X6LdL4F6g67456";
    const TELEGRAM_CHAT_ID = "@capsmonitoreo";

    // --- UTILERIAS ---
    function findKeyCaseInsensitive(map, value) {
        if (!value) return null;
        const lowerValue = value.toLowerCase();
        for (const key in map) {
            if (key.toLowerCase() === lowerValue) {
                return key;
            }
        }
        return null;
    }

    async function cargarCSV(url) {
      try {
          // A√±adir cache buster para asegurar la carga de la versi√≥n m√°s reciente
          const urlConCacheBuster = `${url}?t=${new Date().getTime()}`;
          const res = await fetch(urlConCacheBuster);
          const contentType = res.headers.get("content-type");
          if (contentType && !contentType.includes("text/csv") && !contentType.includes("text/plain")) {
              if (contentType.includes("text/html")) {
                  throw new Error(`Contenido HTML inesperado. Revise ruta: ${url}`);
              }
          }
          const buffer = await res.arrayBuffer();
          const decoder = new TextDecoder('utf-8');
          const texto = decoder.decode(buffer);
          // Procesa el texto CSV: separa por l√≠nea, limpia espacios, toma solo el primer valor de cada l√≠nea,
          // filtra valores vac√≠os y duplciados, y ordena.
          return texto.split('\n')
              .map(linea => linea.trim())
              .filter(linea => linea.length > 0)
              .map(linea => linea.split(',')[0].trim())
              .filter((valor, indice, self) => valor.length > 0 && self.indexOf(valor) === indice)
              .sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
      } catch (error) {
          console.error(`Error al cargar CSV de ${url}:`, error);
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-carga';
          errorDiv.textContent = `‚ùå Error al cargar datos de ${url}. Revisa la consola para m√°s detalles.`;
          document.body.insertBefore(errorDiv, document.querySelector('h2'));
          return []; 
      }
    }

    async function cargarLista(url) {
        const lista = await cargarCSV(url);
        return lista;
    }

    // --- PERSISTENCIA Y ESTADO ---

    function guardarNotas() {
      localStorage.setItem('notasCapturadas', JSON.stringify(notas));
      localStorage.setItem('nextOrdenCaptura', nextOrdenCaptura.toString());
    }

    function cargarNotasGuardadas() {
        const datosJSON = localStorage.getItem('notasCapturadas');
        const ordenJSON = localStorage.getItem('nextOrdenCaptura');
        if (ordenJSON) nextOrdenCaptura = parseInt(ordenJSON, 10);
        
        if (datosJSON) {
            try {
                notas = JSON.parse(datosJSON);
                // Asegura que todas las notas tienen ordenCaptura 
                notas.forEach(nota => {
                    if (!nota.ordenCaptura) nota.ordenCaptura = nextOrdenCaptura++;
                });
                ordenarTabla(ordenActual.columna, true);
            } catch (e) {
                console.error("Error al cargar notas:", e);
                notas = [];
            }
        } else {
            actualizarIndicadoresOrden(); 
        }
    }

    function resetearEstadoEdicion() {
      filaEnEdicion = null;
      document.querySelectorAll('#tablaNotas tr').forEach(tr => tr.classList.remove('editando'));
      document.getElementById('btnEliminar').style.display = 'none';
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
    }

    // --- FORMULARIO Y BLOQUEO ---

    function alternarBloqueo(idCampo) {
        const campo = document.getElementById(idCampo);
        const checkboxId = `check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`;
        const checkbox = document.getElementById(checkboxId);
        
        const isBloqueado = checkbox.checked;

        if (isBloqueado) {
            campo.classList.add('bloqueado');
            campo.setAttribute('readonly', 'readonly');
            localStorage.setItem(`bloqueado_${idCampo}`, 'true');
        } else {
            campo.classList.remove('bloqueado');
            campo.removeAttribute('readonly');
            localStorage.removeItem(`bloqueado_${idCampo}`);
        }
    }

    // --- AUTOCOMPLETAR/SUGERENCIAS ---

    function autocompletar(idCampo, idSugerencias, lista) {
        const campo = document.getElementById(idCampo);
        const contenedor = document.getElementById(idSugerencias);
        campo.dataset.lista = JSON.stringify(lista); 
        let indice = -1;

        function handleSelection(valorSeleccionado) {
            // L√≥gica adicional si se requiere al seleccionar una sugerencia.
        }

        campo.addEventListener("input", () => {
            const valor = campo.value.toLowerCase().trim();
            contenedor.innerHTML = "";
            indice = -1;
            if (!valor) return;

            const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));
            sugerencias.forEach((s, i) => {
                const div = document.createElement("div");
                div.textContent = s;
                div.className = "sugerencia";
                div.dataset.index = i;
                div.onclick = () => {
                    campo.value = s;
                    contenedor.innerHTML = "";
                    handleSelection(s); 
                };
                contenedor.appendChild(div);
            });
        });

        campo.addEventListener("keydown", e => {
            const items = contenedor.querySelectorAll(".sugerencia");
            if (items.length === 0) return;

            if (e.key === "ArrowDown") {
                e.preventDefault();
                indice = (indice + 1) % items.length;
                resaltar(items, indice);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                indice = (indice - 1 + items.length) % items.length;
                resaltar(items, indice);
            } else if (e.key === "Enter" || e.key === "Tab") { 
                // Aqu√≠ usamos Enter y Tab para seleccionar la sugerencia.
                // En el caso de Enter, se previene el comportamiento de navegaci√≥n general.
                if (e.key === "Enter") {
                    e.preventDefault();
                }
                
                if (indice >= 0 && items[indice]) {
                    const valorSeleccionado = items[indice].textContent;
                    campo.value = valorSeleccionado;
                    contenedor.innerHTML = "";
                    handleSelection(valorSeleccionado); 
                } else {
                    // Si no hay selecci√≥n resaltada, se cierra el men√∫ de sugerencias.
                    contenedor.innerHTML = "";
                }
            }
        });

        campo.addEventListener("focus", () => {
            document.querySelectorAll('.sugerencias').forEach(sug => {
                if (sug.id !== idSugerencias) {
                    sug.innerHTML = "";
                }
            });
        });

        campo.addEventListener("blur", (e) => {
            setTimeout(() => {
                if (!contenedor.contains(document.activeElement)) {
                    contenedor.innerHTML = "";
                }
            }, 150);
        });

        function resaltar(items, i) {
            items.forEach(el => el.classList.remove("resaltado"));
            items[i].classList.add("resaltado");
            items[i].scrollIntoView({ block: 'nearest' });
        }
    }

    function mostrarSugerencias(idCampo, idSugerencias) {
        const campo = document.getElementById(idCampo);
        const contenedor = document.getElementById(idSugerencias);
        document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = ""); 
        
        const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
        contenedor.innerHTML = "";
        
        lista.forEach((s, i) => {
            const div = document.createElement("div");
            div.textContent = s;
            div.className = "sugerencia";
            div.dataset.index = i;
            div.onclick = () => {
                campo.value = s;
                contenedor.innerHTML = "";
            };
            contenedor.appendChild(div);
        });

        if(campo.value) {
            campo.dispatchEvent(new Event('input'));
        }
    }

    // --- TABLA Y ACCIONES DE NOTAS ---

    function editarNota(fila) {
      resetearEstadoEdicion();

      fila.classList.add('editando');
      filaEnEdicion = parseInt(fila.dataset.index, 10);

      const notaAEditar = notas[filaEnEdicion];
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        document.getElementById(id).value = notaAEditar[id] || '';
      });

      document.getElementById('btnEliminar').style.display = 'inline-block';
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Actualizar';
      document.getElementById('titular').focus();
    }

    function borrarNota() {
      if (filaEnEdicion !== null) {
        const confirmar = confirm(`¬øEst√°s seguro de eliminar la nota #${notas[filaEnEdicion].ordenCaptura} - "${notas[filaEnEdicion].titular}"?`);
        if (confirmar) {
          notas.splice(filaEnEdicion, 1); 
          guardarNotas();
          ordenarTabla(ordenActual.columna, true); 
          document.querySelector("form").reset();
          resetearEstadoEdicion();
          
          camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
             if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
                 localStorage.removeItem(id); 
             }
          });
        }
      }
    }
    
    // Define los campos obligatorios para la validaci√≥n
    function contieneCamposVacios(nota) {
        const camposObligatorios = ['usuario', 'fecha', 'radiodifusora', 'titular']; 
        const camposFaltantes = [];

        for (const campo of camposObligatorios) {
            if (!nota[campo] || (typeof nota[campo] === 'string' && nota[campo].trim() === '')) {
                const labelElement = document.querySelector(`label[for="${campo}"]`);
                camposFaltantes.push(labelElement ? labelElement.textContent.replace(':', '').trim() : campo);
            }
        }
        return camposFaltantes;
    }


    function renderizarTabla() {
      const tablaBody = document.getElementById("tablaNotas").querySelector("tbody");
      tablaBody.innerHTML = '';
      
      const filtro = document.getElementById('buscador').value.toLowerCase();
      const notasFiltradas = notas.filter(nota => {
          if (!filtro) return true; 

          return camposDeDatos.some(campo => {
              if (campo === 'ordenCaptura' || campo === 'acciones') return false;
              const valor = (nota[campo] || '').toString().toLowerCase();
              return valor.includes(filtro);
          });
      });

      notasFiltradas.forEach((nota, indice) => {
        const tr = document.createElement("tr");
        tr.dataset.index = notas.indexOf(nota); 
        
        const camposFaltantes = contieneCamposVacios(nota);
        if (camposFaltantes.length > 0) {
            tr.classList.add('alerta-vacio');
        }

        camposDeDatos.forEach(campo => {
          const td = document.createElement("td");
          td.textContent = nota[campo];
          td.setAttribute('data-label', encabezadosTabla[campo]);
          tr.appendChild(td);
        });

        const tdAcciones = document.createElement("td");
        tdAcciones.setAttribute('data-label', encabezadosTabla['acciones']);
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar";
        btnEditar.classList.add('btn-accion-tabla');
        btnEditar.onclick = function() {
          editarNota(tr);
        };
        tdAcciones.appendChild(btnEditar);
        tr.appendChild(tdAcciones);
        tablaBody.appendChild(tr);
      });
    }

    function filtrarTabla() {
        renderizarTabla();
    }


    function ordenarTabla(columna, forzarDireccion = false) {
      let direccion = ordenActual.direccion;

      if (!forzarDireccion) {
          if (ordenActual.columna === columna) {
              direccion = direccion === 'asc' ? 'desc' : 'asc';
          } else {
              direccion = 'asc';
          }
      } else {
          direccion = ordenActual.direccion; 
      }

      notas.sort((notaA, notaB) => {
          const valA = notaA[columna];
          const valB = notaB[columna];
          let comparacion = 0;

          if (columna === 'ordenCaptura') {
              comparacion = valA - valB;
          } else if (columna === 'fecha') {
              const dateA = new Date(valA + 'T00:00:00');
              const dateB = new Date(valB + 'T00:00:00');
              if (dateA < dateB) comparacion = -1;
              if (dateA > dateB) comparacion = 1;
          } else {
              comparacion = (valA || '').toString().localeCompare((valB || '').toString(), 'es', { sensitivity: 'base' });
          }

          return direccion === 'asc' ? comparacion : -comparacion;
      });

      ordenActual = { columna, direccion };
      actualizarIndicadoresOrden();
      renderizarTabla();
    }


    function actualizarIndicadoresOrden() {
      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
        const headerDiv = th.querySelector('.sortable-header');
        const iconSpan = th.querySelector('.sort-icon');
        const col = th.dataset.col;

        headerDiv.classList.remove('sorted');
        iconSpan.innerHTML = '';

        if (col === ordenActual.columna) {
          headerDiv.classList.add('sorted');
          iconSpan.innerHTML = ordenActual.direccion === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
        } else {
          iconSpan.innerHTML = '<i class="fas fa-sort"></i>';
        }
      });
    }

    // --- ACCIONES GLOBALES ---

    function generarCSVContenido() {
      const datosParaExportar = notas.slice(); 
      
      const encabezados = camposDeDatos.filter(c => c !== 'acciones').map(key => `"${encabezadosTabla[key].replace(/"/g, '""')}"`);
      const filas = [encabezados];

      datosParaExportar.forEach(nota => {
        const fila = camposDeDatos.filter(c => c !== 'acciones').map(campo => {
          let valor = nota[campo] || '';
          valor = valor.toString().replace(/"/g, '""'); 
          return `"${valor}"`;
        });
        filas.push(fila);
      });

      return "\uFEFF" + filas.map(f => f.join(",")).join("\n");
    }

    function generarNombreArchivoCSV() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); 
        const dd = String(today.getDate()).padStart(2, '0');
        return `Reporte_Notas_Radio_${yyyy}${mm}${dd}.csv`;
    }

    function exportarCSV() {
      if (notas.length === 0) {
        alert("No hay notas para exportar.");
        return;
      }

      const csvContenido = generarCSVContenido();
      const nombreArchivo = generarNombreArchivoCSV();

      const blob = new Blob([csvContenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombreArchivo;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function enviarTelegram() {
      if (notas.length === 0) {
        alert("No hay notas para enviar por Telegram.");
        return;
      }
      
      const URL_TELEGRAM = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`;
      
      try {
        const btn = document.getElementById('btnTelegram');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';

        const csvContenido = generarCSVContenido();
        const blobCSV = new Blob([csvContenido], { type: "text/csv;charset=utf-8;" });
        const nombreArchivoTelegram = generarNombreArchivoCSV();

        const formData = new FormData();
        formData.append('chat_id', TELEGRAM_CHAT_ID);
        formData.append('document', blobCSV, nombreArchivoTelegram);
        formData.append('caption', `üìã Reporte de notas de Radio (${nombreArchivoTelegram}) enviado autom√°ticamente.`);

        const response = await fetch(URL_TELEGRAM, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        
        if (response.ok && result.ok) {
          alert(`¬°CSV '${nombreArchivoTelegram}' enviado con √©xito al canal ${TELEGRAM_CHAT_ID}!`);
        } else {
          console.error("Error Telegram:", result);
          alert(`Error Telegram: ${result.description || "Error desconocido"}`);
        }
      } catch (error) {
        console.error("Error conexi√≥n:", error);
        alert("Error al intentar comunicarse con Telegram. Revisa la consola.");
      } finally {
        document.getElementById('btnTelegram').disabled = false;
        document.getElementById('btnTelegram').innerHTML = '<i class="fa-brands fa-telegram"></i> Enviar por Telegram';
      }
    }


    function borrarTodasLasNotas() {
      if (notas.length === 0) {
        alert("No hay notas para borrar.");
        return;
      }
      const confirmar = confirm(`¬øEst√°s seguro de eliminar PERMANENTEMENTE ${notas.length} notas capturadas? Esta acci√≥n no se puede deshacer.`);
      if (confirmar) {
        notas = [];
        nextOrdenCaptura = 1;
        guardarNotas();
        ordenarTabla(ordenActual.columna, true); 
        document.querySelector("form").reset();
        resetearEstadoEdicion();
        
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
             if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
                 localStorage.removeItem(id); 
             }
        });
        alert("Todas las notas han sido eliminadas.");
      }
    }
    
    async function enviarSugerenciaTema() {
        const input = document.getElementById('inputSugerenciaTema');
        const tema = input.value.trim();
        const mensajeDiv = document.getElementById('mensajeSugerencia');
        const btn = document.getElementById('btnSugerirTema');

        mensajeDiv.textContent = ''; 

        if (!tema) {
            mensajeDiv.style.color = 'yellow';
            mensajeDiv.textContent = 'Escribe una sugerencia de tema.';
            input.focus();
            return;
        }

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';

            const payload = {
                action: 'sugerirTema', 
                tema: tema
            };

            const response = await fetch(GAS_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded' 
                },
                body: new URLSearchParams(payload)
            });

            const textResponse = await response.text();
            let result;

            try {
                result = JSON.parse(textResponse);
            } catch (e) {
                mensajeDiv.style.color = 'red';
                mensajeDiv.textContent = `‚ùå Error: Respuesta inesperada del script. Revisa el c√≥digo de tu App Script.`;
                console.error("Error al parsear la respuesta JSON:", e, "Respuesta recibida:", textResponse);
                return;
            }

            if (result && result.estado === "ok") {
                mensajeDiv.style.color = 'lightgreen';
                mensajeDiv.textContent = `‚úÖ Sugerencia enviada: "${tema}"`;
                input.value = ''; 
            } else {
                mensajeDiv.style.color = 'red';
                mensajeDiv.textContent = `‚ùå Error al guardar en Hoja de C√°lculo: ${result.error || "Error desconocido"}`;
                console.error("Error App Script:", result);
            }
        } catch (error) {
            mensajeDiv.style.color = 'red';
            mensajeDiv.textContent = `‚ùå Error de conexi√≥n. Revisa la consola (F12) para detalles de red y verifica que tu App Script est√© desplegado correctamente.`;
            console.error("Error de red/conexi√≥n:", error);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> Sugerir Tema';
        }
    }


    // --- INICIALIZACI√ìN ---

    window.onload = async () => {
      // 1. Cargar datos CSV para autocompletar
      autocompletar("dependencia", "sugDep", await cargarLista(urls.dependencias));
      autocompletar("radiodifusora", "sugRadiodifusora", await cargarLista(urls.radiodifusoras));
      autocompletar("genero", "sugGenero", await cargarLista(urls.generos));
      autocompletar("estatus", "sugEstatus", await cargarLista(urls.estatus));
      autocompletar("tema", "sugTema", await cargarLista(urls.temas));
      autocompletar("municipio", "sugMunicipio", await cargarLista(urls.municipios));
      autocompletar("autor", "sugAutor", await cargarLista(urls.autores));
      autocompletar("canal", "sugCanal", await cargarLista("./Canal.csv")); 
      
      // 2. Listener para el buscador en tiempo real
      document.getElementById('buscador').addEventListener('input', filtrarTabla);

      // 3. Persistencia y Bloqueo de campos
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
          const campo = document.getElementById(id);

          // Cargar valor persistente
          if (localStorage.getItem(id)) {
              campo.value = localStorage.getItem(id);
          }

          // Guardar valor al cambiar (Persistencia)
          campo.addEventListener("input", () => {
              localStorage.setItem(id, campo.value);
          });
          
          // Aplicar estado de bloqueo si estaba bloqueado
          const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
          if (chk) {
              if (localStorage.getItem(`bloqueado_${id}`) === 'true') {
                  chk.checked = true;
                  alternarBloqueo(id); 
              }
          }
      });

      // 4. Cargar y renderizar notas
      cargarNotasGuardadas();
      renderizarTabla();
      
      // 5. Inicializar listeners de cabeceras de tabla para ordenar
      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
          if (th.dataset.col !== 'acciones') { 
              th.querySelector('.sortable-header').onclick = () => ordenarTabla(th.dataset.col);
          }
      });
      
      // 6. Listener para el env√≠o del formulario (Guardar/Actualizar)
      document.querySelector("form").addEventListener("submit", e => {
          e.preventDefault();
          
          const nuevaNota = {};
          camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
              nuevaNota[id] = document.getElementById(id).value.trim();
          });
          
          // 1. Validar que no faltan campos obligatorios
          const camposFaltantes = contieneCamposVacios(nuevaNota);

          if (camposFaltantes.length > 0) {
              alert(`üö® Por favor, llene los siguientes campos obligatorios: \n\n${camposFaltantes.join(', ')}`);
              return; 
          }
          
          // 2. Guardar/Actualizar nota
          if (filaEnEdicion !== null) {
              nuevaNota.ordenCaptura = notas[filaEnEdicion].ordenCaptura;
              notas[filaEnEdicion] = nuevaNota;
              resetearEstadoEdicion();
          } else {
              nuevaNota.ordenCaptura = nextOrdenCaptura++; 
              notas.push(nuevaNota);
          }
          
          guardarNotas();
          ordenarTabla(ordenActual.columna, true); 
          
          // 3. Limpiar campos NO bloqueados y eliminar su persistencia
          camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
              if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
                  document.getElementById(id).value = ''; 
                  localStorage.removeItem(id); 
              }
          });
          
          // 4. Devolver el foco al campo Titular para nueva nota
          setTimeout(() => {
              document.getElementById('titular').focus();
              resetearEstadoEdicion(); 
          }, 10);
      });

      // 7. Listener para cerrar sugerencias al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.campo') && !e.target.closest('.sugerencias')) {
            document.querySelectorAll('.sugerencias').forEach(s => s.innerHTML = "");
        }
      });

      // 8. Inicializar la fecha al d√≠a de hoy si no est√° bloqueada
      const inputFecha = document.getElementById('fecha');
      const checkFecha = document.getElementById('checkFecha');
      if (inputFecha && checkFecha) {
        if (localStorage.getItem(`bloqueado_fecha`) !== 'true' && !inputFecha.value) {
            const today = new Date().toISOString().split('T')[0];
            inputFecha.value = today;
            localStorage.setItem('fecha', today);
        }
      }

      // 9. Manejo de atajos y navegaci√≥n (Nuevo)
      const orderedInputIds = [
          "usuario", "fecha", "radiodifusora", "titular", "autor", "programa",
          "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"
      ];
      
      document.addEventListener('keydown', e => {
          // Atajo: Ctrl + Q para Guardar
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'q') {
              e.preventDefault(); 
              document.querySelector("form").dispatchEvent(new Event('submit', { cancelable: true })); 
              return;
          }

          // Navegaci√≥n: Enter para pasar al siguiente campo (solo si estamos en un input de la lista)
          if (e.key === 'Enter') {
              const activeElement = document.activeElement;
              const activeId = activeElement.id;
              const currentIndex = orderedInputIds.indexOf(activeId);

              // 1. Prevenir la acci√≥n por defecto del Enter (Guardado del formulario)
              if (activeElement.form) {
                  e.preventDefault();
              }

              // 2. Si estamos en un campo de la lista y no es el √∫ltimo, mover el foco.
              if (currentIndex !== -1) {
                  const nextIndex = currentIndex + 1;
                  if (nextIndex < orderedInputIds.length) {
                      document.getElementById(orderedInputIds[nextIndex]).focus();
                  } else {
                      // Si es el √∫ltimo input, pasar al bot√≥n Guardar
                      document.getElementById('btnGuardar').focus();
                  }
              } else if (activeId === 'btnGuardar') {
                   // Si est√° en Guardar, entonces s√≠ se env√≠a el formulario
                   document.querySelector("form").dispatchEvent(new Event('submit', { cancelable: true }));
              }
          }
      });
    };
  </script>
</body>
</html>