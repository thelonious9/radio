<script>
    // --- VARIABLES GLOBALES ---
    let notas = [];
    let nextOrdenCaptura = 1;
    let filaEnEdicion = null;
    const camposDeDatos = [
        "ordenCaptura", "usuario", "fecha", "radiodifusora", "titular", 
        "autor", "programa", "dependencia", "organismo", "genero", 
        "canal", "tema", "estatus", "municipio"
    ];
    const encabezadosTabla = {
        "ordenCaptura": "#",
        "usuario": "Usuario",
        "fecha": "Fecha",
        "radiodifusora": "Radiodifusora",
        "titular": "Titular",
        "autor": "Autor",
        "programa": "Programa",
        "dependencia": "Dependencia",
        "organismo": "Organismo",
        "genero": "G茅nero",
        "canal": "Canal",
        "tema": "Tema",
        "estatus": "Estatus",
        "municipio": "Municipio",
        "acciones": "Acciones"
    };
    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' };

    // RUTAS RELATIVAS (Aseg煤rate de que estos archivos CSV existan en la misma carpeta)
    const urls = {
        dependencias: "./Dependencia.csv",
        radiodifusoras: "./Radiodifusora.csv",
        generos: "./Genero.csv",
        estatus: "./Estatus.csv",
        temas: "./Tema.csv",
        municipios: "./Municipio.csv",
        autores: "./Autor.csv"
    };

    // RUTA DE DESPLIEGUE DE TU GOOGLE APPS SCRIPT
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzXNixPwsyFiLoC55-u3p5Z1rT1rWX03_alTk3XwDmgjq6t3W5-fjR-Fs3IF_y5wGI/exec";
    
    // CONFIGURACIN TELEGRAM
    const TELEGRAM_BOT_TOKEN = "8428524335:AAFeKrvKrXxrI9NAkL_G1-X6LdL4Fv6fkV4";
    const TELEGRAM_CHAT_ID = "@capsmonitoreo";


    // --- UTILERIAS ---
    async function cargarCSV(url) {
        try {
            const urlConCacheBuster = `${url}?t=${new Date().getTime()}`;
            const res = await fetch(urlConCacheBuster);
            const contentType = res.headers.get("content-type");
            
            if (contentType && !contentType.includes("text/csv") && !contentType.includes("text/plain")) {
                 if (contentType.includes("text/html")) {
                    throw new Error(`Contenido HTML inesperado. Revise la ruta: ${url}`);
                }
            }
            
            const text = await res.text();
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            return lines;
        } catch (error) {
            console.error(`Error al cargar la lista desde ${url}:`, error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-carga';
            errorDiv.textContent = `锔 Error al cargar datos: ${url.split('/').pop()}. Revisa la ruta en JS.`;
            document.body.prepend(errorDiv);
            return [];
        }
    }

    async function cargarLista(url) {
        const lista = await cargarCSV(url);
        return lista;
    }

    function guardarNotas() {
        localStorage.setItem('notasCapturadas', JSON.stringify(notas));
        localStorage.setItem('nextOrdenCaptura', nextOrdenCaptura.toString());
    }

    function resetearEstadoEdicion() {
        filaEnEdicion = null;
        document.getElementById('btnGuardar').textContent = ' Guardar ';
        document.getElementById('btnGuardar').prepend(document.createElement('i')).className = 'fa-solid fa-floppy-disk';
        document.getElementById('btnEliminar').style.display = 'none';
        document.querySelectorAll('.editando').forEach(tr => tr.classList.remove('editando'));
    }

    /**
     * @brief Mueve el foco al siguiente campo de texto o bot贸n Guardar no bloqueado.
     */
    function moveFocusToNextInput(currentInput) {
        const focusableSelectors = 'form input[type="text"]:not([disabled]), form input[type="date"]:not([disabled]), form button#btnGuardar';
        const focusableElements = Array.from(document.querySelectorAll(focusableSelectors));
        const currentIndex = focusableElements.findIndex(el => el === currentInput);

        if (currentIndex !== -1 && currentIndex < focusableElements.length - 1) {
            focusableElements[currentIndex + 1].focus();
            return true;
        }
        return false;
    }


    /**
     * @brief Configura el autocompletado para un campo dado con la l贸gica de selecci贸n Enter/Tab.
     */
    function autocompletar(idCampo, idSugerencias, lista, callback) {
        const campo = document.getElementById(idCampo);
        const contenedor = document.getElementById(idSugerencias);
        campo.dataset.lista = JSON.stringify(lista);
        let indice = -1;

        campo.addEventListener("input", () => {
            const valor = campo.value.toLowerCase().trim();
            contenedor.innerHTML = "";
            indice = -1;
            if (!valor) return;

            const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));

            sugerencias.forEach((s, i) => {
                const div = document.createElement("div");
                div.textContent = s;
                div.className = "sugerencia";
                div.dataset.index = i;
                div.onclick = () => {
                    campo.value = s;
                    contenedor.innerHTML = "";
                    if (callback) callback(s);
                    moveFocusToNextInput(campo);
                };
                contenedor.appendChild(div);
            });
        });

        campo.addEventListener("keydown", e => {
            const items = contenedor.querySelectorAll(".sugerencia");
            
            if (items.length === 0 && e.key === "Enter") {
                 e.preventDefault(); 
                 return;
            }

            if (e.key === "ArrowDown") {
                e.preventDefault();
                indice = (indice + 1) % items.length;
                resaltar(items, indice);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                indice = (indice - 1 + items.length) % items.length;
                resaltar(items, indice);
            } else if (e.key === "Enter" || e.key === "Tab") {
                // L贸gica de autocompletado con Enter/Tab
                const itemToSelect = (items.length === 1 && indice === -1) ? items[0] : (indice >= 0 ? items[indice] : null);
                
                if (itemToSelect) {
                    e.preventDefault();
                    
                    campo.value = itemToSelect.textContent;
                    contenedor.innerHTML = "";
                    if (callback) callback(campo.value);

                    const focusMoved = moveFocusToNextInput(campo);
                    
                    if (e.key === "Enter" && !focusMoved) {
                        document.querySelector("form").dispatchEvent(new Event('submit', { cancelable: true }));
                    }
                    
                } else if (e.key === "Enter") {
                    e.preventDefault();
                }
            }
        });
        
        campo.addEventListener("blur", () => {
            setTimeout(() => {
                if (!contenedor.contains(document.activeElement)) {
                    contenedor.innerHTML = "";
                }
            }, 150);
        });

        function resaltar(items, i) {
            items.forEach(el => el.classList.remove("resaltado"));
            items[i].classList.add("resaltado");
        }
    }

    function mostrarSugerencias(idCampo, idSugerencias) {
        const campo = document.getElementById(idCampo);
        const contenedor = document.getElementById(idSugerencias);
        
        document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = ""); 
        
        const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
        contenedor.innerHTML = "";
        
        if (contenedor.children.length > 0) {
            contenedor.innerHTML = "";
            return;
        }

        lista.forEach((s, i) => {
            const div = document.createElement("div");
            div.textContent = s;
            div.className = "sugerencia";
            div.dataset.index = i;
            div.onclick = () => {
                campo.value = s;
                contenedor.innerHTML = "";
                moveFocusToNextInput(campo);
            };
            contenedor.appendChild(div);
        });
        campo.focus();
    }
    
    function contieneCamposVacios(nota) {
        const camposObligatorios = ["usuario", "fecha", "radiodifusora", "titular"]; 
        return camposObligatorios.filter(campo => !nota[campo] || (typeof nota[campo] === 'string' && nota[campo].trim() === ''));
    }

    function renderizarTabla() {
        const tablaBody = document.getElementById("tablaNotas").querySelector("tbody");
        if (!tablaBody) return; 

        tablaBody.innerHTML = '';
        
        // El filtro se aplica en tiempo real a la tabla ya renderizada por `filtrarTabla()`
        // pero se incluye aqu铆 para asegurar que los elementos se creen.

        const filtro = document.getElementById('buscador').value.toLowerCase();
        const notasFiltradas = notas.filter(nota => {
            if (!filtro) return true; 

            return camposDeDatos.some(campo => {
                if (campo === 'ordenCaptura' || campo === 'acciones') return false;
                const valor = (nota[campo] || '').toString().toLowerCase();
                return valor.includes(filtro);
            });
        });

        notasFiltradas.forEach((nota, indice) => {
            const tr = document.createElement("tr");
            tr.dataset.index = notas.indexOf(nota); 
            
            const camposFaltantes = contieneCamposVacios(nota);
            if (camposFaltantes.length > 0) {
                tr.classList.add('alerta-vacio');
            }

            camposDeDatos.forEach(campo => {
                const td = document.createElement("td");
                let valor = nota[campo];
                if (campo === 'fecha' && valor) {
                    const partes = valor.split('-');
                    if (partes.length === 3) {
                       valor = `${partes[2]}/${partes[1]}/${partes[0]}`; 
                    }
                }
                td.textContent = valor;
                td.setAttribute('data-label', encabezadosTabla[campo]);
                tr.appendChild(td);
            });

            const tdAcciones = document.createElement("td");
            tdAcciones.setAttribute('data-label', encabezadosTabla['acciones']);
            const btnEditar = document.createElement("button");
            btnEditar.textContent = "Editar";
            btnEditar.classList.add('btn-accion-tabla');
            btnEditar.onclick = function() {
                editarNota(tr);
            };
            tdAcciones.appendChild(btnEditar);
            tr.appendChild(tdAcciones);
            tablaBody.appendChild(tr);
        });
    }


    function cargarNotasGuardadas() {
        const datosJSON = localStorage.getItem('notasCapturadas');
        const ordenJSON = localStorage.getItem('nextOrdenCaptura');

        if (ordenJSON) nextOrdenCaptura = parseInt(ordenJSON, 10);
        
        if (datosJSON) {
            try {
                notas = JSON.parse(datosJSON);
                notas.forEach(nota => {
                    if (!nota.ordenCaptura) nota.ordenCaptura = nextOrdenCaptura++;
                });
                ordenarTabla(ordenActual.columna, true);
            } catch (e) {
                console.error("Error al cargar notas:", e);
                notas = [];
            }
        } else {
            actualizarIndicadoresOrden();
        }
    }

    function alternarBloqueo(idCampo) {
        const campo = document.getElementById(idCampo);
        const isBlocked = localStorage.getItem(`bloqueado_${idCampo}`) === 'true';
        
        if (isBlocked) {
            localStorage.removeItem(`bloqueado_${idCampo}`);
            campo.classList.remove('bloqueado');
            campo.disabled = false;
        } else {
            localStorage.setItem(`bloqueado_${idCampo}`, 'true');
            campo.classList.add('bloqueado');
            campo.disabled = true;
            localStorage.setItem(idCampo, campo.value); 
        }
    }
    
    // --- NUEVA FUNCIN PARA DESBLOQUEAR TODO ---
    function desbloquearTodosLosCampos() {
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const campo = document.getElementById(id);
            const checkboxId = `check${id.charAt(0).toUpperCase() + id.slice(1)}`;
            const checkbox = document.getElementById(checkboxId);

            // 1. Quitar bloqueo (visual y funcional)
            if (campo) {
                campo.classList.remove('bloqueado');
                campo.disabled = false;
                campo.removeAttribute('readonly'); 
            }

            // 2. Desmarcar el checkbox
            if (checkbox) checkbox.checked = false;

            // 3. Quitar el estado de bloqueo de la persistencia
            localStorage.removeItem(`bloqueado_${id}`);
            
            // 4. Limpiar la persistencia del valor del campo 
            localStorage.removeItem(id); 
        });
        
        resetearEstadoEdicion();
        
        // Asegurar el foco al primer campo no bloqueado (Usuario o Titular)
        const focusTarget = document.getElementById('usuario') || document.getElementById('titular');
        if (focusTarget) {
            setTimeout(() => focusTarget.focus(), 10);
        }
    }


    function ordenarTabla(columna, forzarRender = false) {
        let direccion = ordenActual.columna === columna && !forzarRender ? (ordenActual.direccion === 'asc' ? 'desc' : 'asc') : 'asc';
        
        notas.sort((notaA, notaB) => {
            const valA = notaA[columna] || "";
            const valB = notaB[columna] || "";
            let comparacion = 0;

            if (columna === 'ordenCaptura') comparacion = valA - valB;
            else if (columna === 'fecha') {
                const dateA = new Date(valA + 'T00:00:00'); 
                const dateB = new Date(valB + 'T00:00:00');
                if (dateA < dateB) comparacion = -1;
                if (dateA > dateB) comparacion = 1;
            } else {
                comparacion = valA.toString().localeCompare(valB.toString(), 'es', { sensitivity: 'base' });
            }
            return direccion === 'asc' ? comparacion : -comparacion;
        });

        ordenActual = { columna, direccion };
        actualizarIndicadoresOrden();
        renderizarTabla();
    }

    function actualizarIndicadoresOrden() {
        document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
            const headerDiv = th.querySelector('.sortable-header');
            const iconSpan = th.querySelector('.sort-icon');
            const col = th.dataset.col;

            if (!headerDiv || !iconSpan) return;

            headerDiv.classList.remove('sorted');
            iconSpan.innerHTML = ''; 

            if (col === ordenActual.columna) {
                headerDiv.classList.add('sorted');
                iconSpan.innerHTML = ordenActual.direccion === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
            } else {
                iconSpan.innerHTML = '<i class="fas fa-sort"></i>';
            }
        });
    }

    function filtrarTabla() {
        const input = document.getElementById('buscador');
        if (!input) return;
        const filtro = input.value.toLowerCase();
        const filas = document.getElementById('tablaNotas').querySelectorAll('tbody tr');
        
        filas.forEach(tr => {
            let encontrado = false;
            for (let i = 0; i < tr.cells.length - 1; i++) { 
                const textoCelda = tr.cells[i].textContent.toLowerCase();
                if (textoCelda.includes(filtro)) {
                    encontrado = true;
                    break;
                }
            }
            tr.style.display = encontrado ? '' : 'none';
        });
    }

    async function enviarSugerenciaTema(tema) {
        const input = document.getElementById('inputSugerenciaTema');
        const mensajeDiv = document.getElementById('mensajeSugerencia');
        const btn = document.getElementById('btnSugerirTema');
        // ... (resto de la funci贸n enviarSugerenciaTema sin cambios)
    }

    // El resto de funciones (exportarCSV, generarCSVContenido, enviarTelegram, borrarTodo) se mantienen.

    // --- INICIALIZACIN ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Cargar datos persistentes
        cargarNotasGuardadas();

        // Inicializar listeners de cabeceras de tabla para ordenar
        document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
            const col = th.dataset.col;
            if (col && col !== 'acciones') {
                th.addEventListener('click', () => ordenarTabla(col));
                // Asegurar que el icono inicial de sorting est茅 presente
                const headerText = th.textContent;
                th.innerHTML = `<div class="sortable-header" data-col="${col}"><span>${headerText}</span><span class="sort-icon"><i class="fas fa-sort"></i></span></div>`;
            }
        });
        
        // Renderizado inicial (despu茅s de cargar y ordenar)
        renderizarTabla();
        
        // Carga y configuraci贸n de autocompletado
        autocompletar("radiodifusora", "sugRadiodifusora", await cargarLista(urls.radiodifusoras));
        autocompletar("dependencia", "sugDep", await cargarLista(urls.dependencias));
        autocompletar("organismo", "sugOrg", await cargarLista("./Organismo.csv"));
        autocompletar("genero", "sugGenero", await cargarLista(urls.generos));
        autocompletar("estatus", "sugEstatus", await cargarLista(urls.estatus));
        autocompletar("tema", "sugTema", await cargarLista(urls.temas));
        autocompletar("municipio", "sugMunicipio", await cargarLista(urls.municipios));
        autocompletar("autor", "sugAutor", await cargarLista(urls.autores));
        autocompletar("canal", "sugCanal", await cargarLista("./Canal.csv"));

        // Listener para el buscador en tiempo real
        document.getElementById('buscador').addEventListener('input', filtrarTabla);

        // Persistence & Locks
        camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const campo = document.getElementById(id);
            // Cargar valor persistente si existe
            if (localStorage.getItem(id)) campo.value = localStorage.getItem(id);
            // Guardar valor en localStorage al cambiar
            campo.addEventListener("input", () => localStorage.setItem(id, campo.value));

            // Cargar estado de bloqueo
            const isBlocked = localStorage.getItem(`bloqueado_${id}`) === 'true';
            const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            if (isBlocked) {
                campo.classList.add('bloqueado');
                campo.disabled = true;
                if (chk) chk.checked = true;
            } else {
                 if (chk) chk.checked = false;
            }
        });

        // Inicializar la fecha al d铆a de hoy si no est谩 bloqueada
        const inputFecha = document.getElementById('fecha');
        if (inputFecha && localStorage.getItem(`bloqueado_fecha`) !== 'true' && !inputFecha.value) {
            const today = new Date().toISOString().split('T')[0];
            inputFecha.value = today;
            localStorage.setItem('fecha', today);
        }

        // --- MANEJO DEL EVENTO DE RESET (LIMPIAR) (Modificaci贸n Solicitada) ---
        document.querySelector("form").addEventListener("reset", e => {
            // El evento 'reset' limpia los valores de la UI, pero no el estado de bloqueo.
            // Esta funci贸n DESBLOQUEA todo y limpia los estados de persistencia de bloqueo/valor.
            desbloquearTodosLosCampos();
        });

        // --- L贸gica de Env铆o del Formulario (Guardar/Actualizar) ---
        document.querySelector("form").addEventListener("submit", e => {
            e.preventDefault();
            
            const nuevaNota = {};
            camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
                nuevaNota[id] = document.getElementById(id).value.trim();
            });

            // 1. Validar si faltan campos obligatorios
            const camposFaltantes = contieneCamposVacios(nuevaNota);

            if (camposFaltantes.length > 0) {
                alert(` Por favor, llene los siguientes campos obligatorios: \n\n${camposFaltantes.join(', ')}`);
                return;
            }
            
            // 2. Guardar/Actualizar nota
            if (filaEnEdicion !== null) {
                nuevaNota.ordenCaptura = notas[filaEnEdicion].ordenCaptura;
                notas[filaEnEdicion] = nuevaNota;
                resetearEstadoEdicion();
            } else {
                nuevaNota.ordenCaptura = nextOrdenCaptura++; 
                notas.push(nuevaNota);
            }
            
            guardarNotas();
            ordenarTabla(ordenActual.columna, true); 
            
            // 3. Limpiar campos NO bloqueados (aunque despu茅s del reset, todos deber铆an estar NO bloqueados)
            camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
                if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
                    document.getElementById(id).value = ''; 
                    localStorage.removeItem(id); 
                }
            });
            
            // 4. Devolver el foco
            setTimeout(() => {
                document.getElementById('titular').focus();
                resetearEstadoEdicion();
            }, 10);
        });

        // Cierre de sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.campo')) {
                document.querySelectorAll('.sugerencias').forEach(s => s.innerHTML = "");
            }
        });
        
        // --- ATAJO DE TECLADO (CTRL + Q) ---
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'q') {
                e.preventDefault();
                document.querySelector("form").dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });
    });
</script>