<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Captura de Notas de Radio</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    /* ImportaciÃ³n de Google Fonts para Roboto */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    /* --- PALETA DE COLORES FINAL --- */
    :root {
      --color-fondo-pagina: #31302F;
      /* Oscuro Suave */
      --color-fondo-form: #52504E;
      /* Gris CÃ¡lido (Fondo del Formulario/Tabla) */
      --color-primary: #6F0909;
      /* Rojo Intenso (BotÃ³n Guardar/Encabezado Tabla) */
      --color-primary-hover: #792929;
      /* Rojo Suave (Hover) */
      --color-secondary: #792929;
      /* Rojo Suave (BotÃ³n Limpiar/Iconos) */
      --color-secondary-hover: #6F0909;
      /* Rojo Intenso (Hover) */
      --color-danger: #6F0909;
      /* Rojo Intenso para advertencias/eliminar */
      --color-danger-hover: #792929;
      /* Rojo Suave */
      --color-sheets: #3C7550;
      /* Color Google Sheets */
      --color-sheets-hover: #316042;
      --color-dark-text: #31302F;
      /* Texto para inputs (fondo claro) */
      --color-light-text: #F0EAD1;
      /* Texto principal (fondo oscuro) */
      --color-input-bg: #F0EAD1;
      /* Fondo de los campos de texto */
      --color-alerta-vacio: #FFD700;
      /* Amarillo/Oro llamativo para alertas */
      --radius: 0.25rem;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--color-fondo-pagina);
      color: var(--color-light-text);
    }

    h1 {
      font-size: 1.8rem;
      color: var(--color-light-text);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--color-primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      background-color: var(--color-fondo-form);
      padding: 10px 20px 15px 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    header img {
      height: 50px;
      width: auto;
    }

    /* --- FORMULARIO --- */
    form {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 15px 30px;
      max-width: 900px;
      margin: 0 auto 30px auto;
      padding: 25px;
      background-color: var(--color-fondo-form);
      border-radius: var(--radius);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .form-logo-container {
      grid-column: span 4;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--color-secondary);
    }

    .form-logo-container img {
      height: 80px;
      width: auto;
      opacity: 0.9;
    }

    label {
      font-weight: 700;
      align-self: center;
      color: var(--color-light-text);
    }

    .campo {
      position: relative;
      display: flex;
      align-items: center;
    }

    .campo>input[type="text"],
    .campo>input[type="date"],
    .campo>textarea {
      flex-grow: 1;
      padding: 8px 10px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      margin-right: 10px;
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      font-family: inherit;
      /* Asegurar que use Roboto */
    }

    .campo>input[type="text"]:focus,
    .campo>input[type="date"]:focus,
    .campo>textarea:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(210, 10, 17, 0.25);
      outline: none;
    }

    .campo>textarea {
      resize: none;
      overflow-y: hidden;
      min-height: 40px;
      line-height: 1.4;
    }

    form>label:nth-child(8),
    form>div:nth-child(9) {
      grid-column: span 4;
    }

    /* --- SUGERENCIAS --- */
    .sugerencias {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      border: 1px solid var(--color-primary-hover);
      background: var(--color-input-bg);
      max-height: 180px;
      overflow-y: auto;
      z-index: 100;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      color: var(--color-dark-text);
    }

    .sugerencia {
      padding: 8px 10px;
      cursor: pointer;
    }

    .sugerencia:hover,
    .sugerencia.resaltado {
      background-color: #f0f0f0;
      color: var(--color-dark-text);
    }

    /* --- BLOQUEO --- */
    .bloqueado {
      background-color: #e9e9e9 !important;
      border: 1px solid var(--color-primary-hover) !important;
    }

    input:required:invalid {
      border-left: 5px solid var(--color-danger);
    }

    input:required:valid {
      border-left: 5px solid #28a745;
    }

    /* --- BOTONES --- */
    .button-group-form {
      grid-column: span 4;
      display: flex;
      gap: 15px;
      margin-top: 10px;
      justify-content: flex-end;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.2s ease, transform 0.1s;
      color: var(--color-light-text);
      margin-right: 5px;
    }

    #btnGuardar {
      background-color: var(--color-primary);
    }

    #btnGuardar:hover {
      background-color: var(--color-primary-hover);
      transform: translateY(-1px);
    }

    #btnLimpiar {
      background-color: var(--color-secondary);
    }

    #btnLimpiar:hover {
      background-color: var(--color-secondary-hover);
      transform: translateY(-1px);
    }

    #btnEliminar {
      background-color: var(--color-danger);
    }

    #btnEliminar:hover {
      background-color: var(--color-danger-hover);
      transform: translateY(-1px);
    }

    .campo button[type="button"] {
      background-color: var(--color-secondary);
      padding: 8px;
      margin-right: 0;
    }

    .campo button[type="button"]:hover {
      background-color: var(--color-secondary-hover);
    }

    button i {
      margin-right: 8px;
      font-size: 1.1em;
    }

    /* --- TABLA --- */
    h2 {
      margin-top: 40px;
      color: var(--color-light-text);
      border-bottom: 1px solid var(--color-secondary);
      padding-bottom: 5px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
      margin-top: 20px;
      background-color: var(--color-fondo-form);
    }

    th,
    td {
      padding: 12px 15px;
      border: 1px solid #3A3A3A;
      text-align: left;
      color: var(--color-light-text);
      font-size: 0.85rem;
    }

    th {
      background-color: var(--color-primary);
      color: var(--color-light-text);
      font-weight: 700;
      position: sticky;
      top: 0;
    }

    tbody tr:nth-child(even) {
      background-color: #353535;
    }

    .editando {
      background-color: var(--color-primary-hover) !important;
      color: var(--color-light-text);
    }

    .editando td {
      color: var(--color-light-text);
    }

    .alerta-vacio {
      background-color: var(--color-alerta-vacio) !important;
      color: var(--color-dark-text) !important;
    }

    .alerta-vacio td {
      color: var(--color-dark-text) !important;
    }

    .fila-vacia {
      background-color: var(--color-danger) !important;
      color: var(--color-light-text);
    }

    .fila-vacia td {
      color: var(--color-light-text);
    }

    .error-carga {
      color: var(--color-danger);
      font-weight: bold;
      margin-top: 15px;
      background-color: var(--color-input-bg);
      padding: 10px;
      border-radius: var(--radius);
    }

    footer {
      margin-top: 40px;
      border-top: 1px solid var(--color-secondary);
      padding-top: 10px;
      font-size: 0.9em;
      color: var(--color-light-text);
      text-align: center;
    }

    /* --- SORTING --- */
    .sortable-header {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .sort-icon {
      margin-left: 5px;
      font-size: 0.8em;
      opacity: 0.5;
    }

    .sorted .sort-icon {
      opacity: 1;
      color: var(--color-light-text);
    }

    .sorted.alerta-vacio .sort-icon {
      color: var(--color-dark-text);
    }

    /* --- GRUPO DE ACCIONES (Globales) --- */
    .actions-group {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      margin-bottom: 25px;
      justify-content: flex-start;
      align-items: center;
    }

    /* Estilo del nuevo botÃ³n de Google Sheets */
    #btnSheets {
      background-color: var(--color-sheets);
      /* Verde oscuro similar a Google Sheets */
    }

    #btnSheets:hover {
      background-color: var(--color-sheets-hover);
      transform: translateY(-1px);
    }

    /* Estilos existentes */
    #btnExportar {
      background-color: #4A4A4A;
    }

    /* Descargar CSV */
    #btnExportar:hover {
      background-color: #616161;
    }

    #btnBorrarTodo {
      background-color: var(--color-danger);
    }

    #btnBorrarTodo:hover {
      background-color: var(--color-danger-hover);
      transform: translateY(-1px);
    }

    /* BotÃ³n Editar en Tabla */
    .btn-accion-tabla {
      padding: 8px 12px;
      background-color: var(--color-secondary);
      color: var(--color-light-text);
    }

    .btn-accion-tabla:hover {
      background-color: var(--color-secondary-hover);
    }

    /* --- ESTILOS DEL BUSCADOR --- */
    .buscador-container {
      position: relative;
      margin-bottom: 15px;
      max-width: 400px;
    }

    #buscador {
      width: 100%;
      padding: 10px 10px 10px 40px;
      border: 1px solid var(--color-primary-hover);
      border-radius: var(--radius);
      background-color: var(--color-input-bg);
      color: var(--color-dark-text);
      font-size: 1rem;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }

    #buscador:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 0.2rem rgba(210, 10, 17, 0.25);
    }

    .buscador-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-primary);
      font-size: 1.1rem;
    }

    /* --- TOAST MESSAGES (Notificaciones) --- */
    #messageContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast-message {
      padding: 15px 20px;
      border-radius: var(--radius);
      color: var(--color-light-text);
      font-weight: bold;
      opacity: 0.95;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: opacity 0.5s, transform 0.5s;
      transform: translateY(0);
      min-width: 250px;
    }

    .toast-message.success {
      background-color: #28a745;
      /* Verde */
    }

    .toast-message.error {
      background-color: var(--color-danger);
      /* Rojo */
    }

    .toast-message.hide {
      opacity: 0;
      transform: translateY(-20px);
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 10px;
      }

      form {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 15px;
      }

      form>label,
      form>div,
      .form-logo-container {
        grid-column: span 1 !important;
      }

      .button-group-form {
        justify-content: space-around;
      }

      .button-group-form button {
        width: 32%;
        margin-right: 0;
      }

      .actions-group {
        flex-direction: column;
        align-items: stretch;
      }

      .actions-group button {
        width: 100%;
        margin-bottom: 10px;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      tr {
        border: 1px solid #3A3A3A;
        margin-bottom: 10px;
      }

      td {
        border: none;
        border-bottom: 1px solid #4A4A4A;
        position: relative;
        padding-left: 50%;
        text-align: right;
        font-size: 0.9em;
        color: var(--color-light-text);
      }

      td:before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: 600;
      }

      td:last-child {
        text-align: center;
        padding-left: 10px;
      }

      .alerta-vacio td {
        color: var(--color-dark-text) !important;
      }
    }
  </style>
</head>

<body>
  <header>
    <img src="./logo.png" alt="Logotipo institucional">
    <h1>Sistema de Captura de Notas de Radio</h1>
  </header>

  <div id="messageContainer"></div>

  <form>
    <div class="form-logo-container">
      <img src="./logo.png" alt="Logotipo del Formulario">
    </div>

    <label for="usuario">Usuario:</label>
    <div class="campo">
      <input type="text" id="usuario" name="usuario" required>
      <input type="checkbox" id="checkUsuario" onchange="alternarBloqueo('usuario')" tabindex="-1">
      <label for="checkUsuario">ðŸ”’</label>
    </div>

    <label for="fecha">Fecha:</label>
    <div class="campo">
      <input type="date" id="fecha" name="fecha" required>
      <input type="checkbox" id="checkFecha" onchange="alternarBloqueo('fecha')" tabindex="-1">
      <label for="checkFecha">ðŸ”’</label>
    </div>

    <label for="radiodifusora">Radiodifusora:</label>
    <div class="campo">
      <input type="text" id="radiodifusora" name="radiodifusora" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('radiodifusora','sugRadiodifusora')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkRadiodifusora" onchange="alternarBloqueo('radiodifusora')" tabindex="-1">
      <label for="checkRadiodifusora">ðŸ”’</label>
      <div id="sugRadiodifusora" class="sugerencias"></div>
    </div>

    <label for="titular">Titular:</label>
    <div class="campo">
      <textarea id="titular" name="titular" required oninput="autoResize(this)" rows="1"></textarea>
      <input type="checkbox" id="checkTitular" onchange="alternarBloqueo('titular')" tabindex="-1">
      <label for="checkTitular">ðŸ”’</label>
    </div>

    <label for="autor">Autor:</label>
    <div class="campo">
      <input type="text" id="autor" name="autor" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('autor','sugAutor')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkAutor" onchange="alternarBloqueo('autor')" tabindex="-1">
      <label for="checkAutor">ðŸ”’</label>
      <div id="sugAutor" class="sugerencias"></div>
    </div>

    <label for="programa">Programa:</label>
    <div class="campo">
      <input type="text" id="programa" name="programa" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('programa','sugPrograma')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkPrograma" onchange="alternarBloqueo('programa')" tabindex="-1">
      <label for="checkPrograma">ðŸ”’</label>
      <div id="sugPrograma" class="sugerencias"></div>
    </div>

    <label for="dependencia">Dependencia:</label>
    <div class="campo">
      <input type="text" id="dependencia" name="dependencia" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('dependencia','sugDep')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkDependencia" onchange="alternarBloqueo('dependencia')" tabindex="-1">
      <label for="checkDependencia">ðŸ”’</label>
      <div id="sugDep" class="sugerencias"></div>
    </div>

    <label for="organismo">Organismo:</label>
    <div class="campo">
      <input type="text" id="organismo" name="organismo" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('organismo','sugOrg')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkOrganismo" onchange="alternarBloqueo('organismo')" tabindex="-1">
      <label for="checkOrganismo">ðŸ”’</label>
      <div id="sugOrg" class="sugerencias"></div>
    </div>

    <label for="genero">GÃ©nero:</label>
    <div class="campo">
      <input type="text" id="genero" name="genero" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('genero','sugGenero')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkGenero" onchange="alternarBloqueo('genero')" tabindex="-1">
      <label for="checkGenero">ðŸ”’</label>
      <div id="sugGenero" class="sugerencias"></div>
    </div>

    <label for="canal">Canal:</label>
    <div class="campo">
      <input type="text" id="canal" name="canal" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('canal','sugCanal')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkCanal" onchange="alternarBloqueo('canal')" tabindex="-1">
      <label for="checkCanal">ðŸ”’</label>
      <div id="sugCanal" class="sugerencias"></div>
    </div>

    <label for="tema">Tema:</label>
    <div class="campo">
      <input type="text" id="tema" name="tema" autocomplete="off">
      <button type="button" onclick="mostrarSugerencias('tema','sugTema')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkTema" onchange="alternarBloqueo('tema')" tabindex="-1">
      <label for="checkTema">ðŸ”’</label>
      <div id="sugTema" class="sugerencias"></div>
    </div>

    <label for="estatus">Estatus:</label>
    <div class="campo">
      <input type="text" id="estatus" name="estatus" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('estatus','sugEstatus')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkEstatus" onchange="alternarBloqueo('estatus')" tabindex="-1">
      <label for="checkEstatus">ðŸ”’</label>
      <div id="sugEstatus" class="sugerencias"></div>
    </div>

    <label for="municipio">Municipio:</label>
    <div class="campo">
      <input type="text" id="municipio" name="municipio" autocomplete="off" required>
      <button type="button" onclick="mostrarSugerencias('municipio','sugMunicipio')" tabindex="-1">ðŸ”½</button>
      <input type="checkbox" id="checkMunicipio" onchange="alternarBloqueo('municipio')" tabindex="-1">
      <label for="checkMunicipio">ðŸ”’</label>
      <div id="sugMunicipio" class="sugerencias"></div>
    </div>

    <div class="button-group-form">
      <button type="submit" id="btnGuardar">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>

      <button type="button" id="btnEliminar" style="display: none;" onclick="borrarNota()">
        <i class="fa-solid fa-trash-can"></i> Borrar Nota
      </button>

      <button type="reset" id="btnLimpiar">
        <i class="fa-solid fa-broom"></i> Limpiar
      </button>
    </div>
  </form>

  <div class="actions-group">
    <button id="btnSheets" onclick="enviarSheets()">
      <i class="fa-solid fa-file-excel"></i> Enviar a Google Sheets
    </button>

    <button id="btnExportar" onclick="exportarCSV()">
      <i class="fa-solid fa-file-csv"></i> Descargar CSV
    </button>

    <button id="btnBorrarTodo" onclick="borrarTodo()">
      <i class="fa-solid fa-trash-can"></i> Borrar Todas
    </button>
  </div>

  <div id="erroresCarga" class="error-carga"></div>

  <div class="buscador-container">
    <i class="fas fa-search buscador-icon"></i>
    <input type="text" id="buscador" placeholder="Buscar en la tabla (Titular, Autor, etc.)">
  </div>

  <h2>Notas capturadas</h2>
  <table id="tablaNotas">
    <thead>
      <tr>
        <th data-col="ordenCaptura">
          <div class="sortable-header"># <span class="sort-icon"></span></div>
        </th>
        <th data-col="usuario">
          <div class="sortable-header">Usuario <span class="sort-icon"></span></div>
        </th>
        <th data-col="fecha">
          <div class="sortable-header">Fecha <span class="sort-icon"></span></div>
        </th>
        <th data-col="radiodifusora">
          <div class="sortable-header">Radiodifusora <span class="sort-icon"></span></div>
        </th>
        <th data-col="titular">
          <div class="sortable-header">Titular <span class="sort-icon"></span></div>
        </th>
        <th data-col="autor">
          <div class="sortable-header">Autor <span class="sort-icon"></span></div>
        </th>
        <th data-col="programa">
          <div class="sortable-header">Programa <span class="sort-icon"></span></div>
        </th>
        <th data-col="dependencia">
          <div class="sortable-header">Dependencia <span class="sort-icon"></span></div>
        </th>
        <th data-col="organismo">
          <div class="sortable-header">Organismo <span class="sort-icon"></span></div>
        </th>
        <th data-col="genero">
          <div class="sortable-header">GÃ©nero <span class="sort-icon"></span></div>
        </th>
        <th data-col="canal">
          <div class="sortable-header">Canal <span class="sort-icon"></span></div>
          </div>
        </th>
        <th data-col="tema">
          <div class="sortable-header">Tema <span class="sort-icon"></span></div>
        </th>
        <th data-col="estatus">
          <div class="sortable-header">Estatus <span class="sort-icon"></span></div>
        </th>
        <th data-col="municipio">
          <div class="sortable-header">Municipio <span class="sort-icon"></span></div>
        </th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <br>

  <script>
    let notas = [];
    let filaEnEdicion = null;
    let nextOrdenCaptura = 1;

    // CAMPOS PARA RADIO
    const camposDeDatos = ["ordenCaptura", "usuario", "fecha", "radiodifusora", "titular", "autor", "programa", "dependencia", "organismo", "genero", "canal", "tema", "estatus", "municipio"];

    // ENCABEZADOS (Sin columna Telegram individual)
    const encabezadosTabla = {
      "ordenCaptura": "#", "usuario": "Usuario", "fecha": "Fecha", "radiodifusora": "Radiodifusora", "titular": "Titular", "autor": "Autor",
      "programa": "Programa", "dependencia": "Dependencia", "organismo": "Organismo", "genero": "GÃ©nero",
      "canal": "Canal", "tema": "Tema", "estatus": "Estatus", "municipio": "Municipio", "acciones": "Acciones"
    };

    let ordenActual = { columna: 'ordenCaptura', direccion: 'desc' };

    // RUTAS RELATIVAS (AsegÃºrate de que estos archivos estÃ©n en el mismo directorio)
    const urls = {
      dependencias: "./Dependencia.csv",
      radiodifusoras: "./Radiodifusora.csv",
      generos: "./Genero.csv",
      estatus: "./Estatus.csv",
      temas: "./Tema.csv",
      municipios: "./Municipio.csv",
      autores: "./Autor.csv"
    };

    // --- CONFIGURACIÃ“N GOOGLE APP SCRIPT ---
    // URL de despliegue proporcionada por el usuario
    const URL_APP_SCRIPT = "https://script.google.com/macros/s/AKfycbxw9a6kEd2lTlbtU6OcwtmNx4983L-qNvuoh_fHzGDiKisiy7DjN-AwTORvnDQkfRvM/exec";

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + 'px';
    }

    function findKeyCaseInsensitive(map, value) {
      if (!value) return null;
      const lowerValue = value.toLowerCase();
      for (const key in map) {
        if (key.toLowerCase() === lowerValue) {
          return key;
        }
      }
      return null;
    }

    async function cargarCSV(url) {
      try {
        const urlConCacheBuster = `${url}?t=${new Date().getTime()}`;
        const res = await fetch(urlConCacheBuster);

        const contentType = res.headers.get("content-type");
        if (contentType && !contentType.includes("text/csv") && !contentType.includes("text/plain")) {
          if (contentType.includes("text/html")) {
            throw new Error(`Contenido HTML inesperado. Revise ruta: ${url}`);
          }
        }

        const buffer = await res.arrayBuffer();
        const decoder = new TextDecoder('utf-8');
        const texto = decoder.decode(buffer);
        return texto.split('\n').map(linea => linea.split(','));
      } catch (e) {
        document.getElementById("erroresCarga").innerText += `Error al cargar ${url}: ${e.message}\n`;
        return [];
      }
    }

    function limpiarFilasCSV(filas) {
      if (!filas || filas.length === 0) return [];
      filas[0][0] = filas[0][0].replace(/^\uFEFF/, "");
      const encabezado = filas[0].map(c => (c || "").toLowerCase()).join(",");
      const tieneEncabezado = encabezado.includes("dependencia") || encabezado.includes("radiodifusora") || encabezado.includes("gÃ©nero");
      if (tieneEncabezado) filas = filas.slice(1);
      return filas.map(r => r.map(c => (c || "").replace(/<[^>]+>/g, "").trim())).filter(r => r[0]);
    }

    async function cargarMapa(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      const map = {};
      filas.forEach(([clave, valor]) => {
        if (!clave) return;
        map[clave] = map[clave] || new Set();
        if (valor) map[clave].add(valor);
      });
      const claves = Object.keys(map).sort((a, b) => a.localeCompare(b, 'es'));
      const mapArrays = {};
      claves.forEach(k => mapArrays[k] = Array.from(map[k]).sort((a, b) => a.localeCompare(b, 'es')));
      return { claves, map: mapArrays };
    }

    async function cargarLista(url) {
      const filas = limpiarFilasCSV(await cargarCSV(url));
      return Array.from(new Set(filas.map(r => r[0]))).sort((a, b) => a.localeCompare(b, 'es'));
    }

    function autocompletar(idCampo, idSugerencias, lista, callback) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      campo.dataset.lista = JSON.stringify(lista);
      let indice = -1;

      campo.addEventListener("input", () => {
        const valor = campo.value.toLowerCase().trim();
        contenedor.innerHTML = "";
        indice = -1;
        if (!valor) return;
        const sugerencias = lista.filter(item => item.toLowerCase().includes(valor));
        sugerencias.forEach((s, i) => {
          const div = document.createElement("div");
          div.textContent = s;
          div.className = "sugerencia";
          div.dataset.index = i;
          div.onclick = () => {
            campo.value = s;
            contenedor.innerHTML = "";
            if (callback) callback(s);
            // Enfocar el siguiente input al seleccionar con mouse
            focusNextInput(campo);
          };
          contenedor.appendChild(div);
        });
      });

      campo.addEventListener("keydown", e => {
        const items = contenedor.querySelectorAll(".sugerencia");
        const isEnter = e.key === "Enter";
        const isTab = e.key === "Tab";
        const isUp = e.key === "ArrowUp";
        const isDown = e.key === "ArrowDown";

        // 1. Comportamiento de flechas
        if (isDown) {
          e.preventDefault();
          if (items.length > 0) {
            indice = (indice + 1) % items.length;
            resaltar(items, indice);
          }
          return;
        } else if (isUp) {
          e.preventDefault();
          if (items.length > 0) {
            indice = (indice - 1 + items.length) % items.length;
            resaltar(items, indice);
          }
          return;
        }

        // 2. Comportamiento de Enter/Tab
        if (isEnter || isTab) {

          const focusFunction = isTab && e.shiftKey ? focusPrevInput : focusNextInput;
          let valorSeleccionado = null;

          // A. Prioridad: Sugerencia resaltada (usando flechas)
          if (indice >= 0 && items[indice]) {
            valorSeleccionado = items[indice].textContent;
          }
          // B. SelecciÃ³n de Sugerencia Ãšnica Visible
          else if (items.length === 1) {
            valorSeleccionado = items[0].textContent;
          }

          // C. Aplicar selecciÃ³n si existe
          if (valorSeleccionado) {
            campo.value = valorSeleccionado;
            if (callback) callback(campo.value);
          }

          // D. Limpia sugerencias y mueve el foco (solo si es Enter)
          contenedor.innerHTML = "";
          if (isEnter) {
            e.preventDefault(); // Prevenir el submit en caso de Enter
            focusFunction(campo);
          }
        }
      });

      campo.addEventListener("focus", () => {
        document.querySelectorAll('.sugerencias').forEach(sug => {
          if (sug.id !== idSugerencias) {
            sug.innerHTML = "";
          }
        });
      });

      campo.addEventListener("blur", () => {
        setTimeout(() => {
          if (!contenedor.contains(document.activeElement)) {
            contenedor.innerHTML = "";
          }
        }, 150);
      });

      function resaltar(items, i) {
        items.forEach(el => el.classList.remove("resaltado"));
        items[i].classList.add("resaltado");
        // Scroll para asegurar que la sugerencia estÃ© visible
        items[i].parentElement.scrollTop = items[i].offsetTop - items[i].parentElement.offsetTop;
      }
    }

    function mostrarSugerencias(idCampo, idSugerencias) {
      const campo = document.getElementById(idCampo);
      const contenedor = document.getElementById(idSugerencias);
      document.querySelectorAll('.sugerencias').forEach(sug => sug.innerHTML = "");

      const lista = campo.dataset.lista ? JSON.parse(campo.dataset.lista) : [];
      contenedor.innerHTML = "";
      lista.forEach((s, i) => {
        const div = document.createElement("div");
        div.textContent = s;
        div.className = "sugerencia";
        div.dataset.index = i;
        div.onclick = () => {
          campo.value = s;
          contenedor.innerHTML = "";
          // Disparar blur para manejar campos dependientes (ej. Dependencia -> Organismo)
          if (idCampo === 'radiodifusora' || idCampo === 'dependencia') {
            campo.dispatchEvent(new Event('blur'));
          }
          // Enfocar el siguiente input al seleccionar con mouse
          focusNextInput(campo);
        };
        contenedor.appendChild(div);
      });
      if (lista.length > 0) {
        contenedor.style.display = 'block';
      }
    }

    function resetearEstadoEdicion() {
      filaEnEdicion = null;
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
      document.getElementById('btnEliminar').style.display = 'none';
      document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
    }

    function guardarNotas() {
      localStorage.setItem('notasCapturadas', JSON.stringify(notas));
      localStorage.setItem('nextOrdenCaptura', nextOrdenCaptura);
    }

    function borrarTodo() {
      if (confirm("Â¿EstÃ¡s seguro de que quieres BORRAR TODAS las notas capturadas? Esta acciÃ³n es irreversible.")) {
        notas = [];
        nextOrdenCaptura = 1;
        guardarNotas();
        renderizarTabla();
        resetearEstadoEdicion();
        mostrarMensaje('ðŸ—‘ï¸ Todas las notas han sido borradas.', 'error');
      }
    }

    function borrarNota() {
      if (filaEnEdicion !== null) {
        const confirmar = confirm(`Â¿Eliminar nota #${notas[filaEnEdicion].ordenCaptura}?`);
        if (confirmar) {
          // Guardar el estado de ordenaciÃ³n antes de re-indexar
          const currentCol = ordenActual.columna;
          const currentDir = ordenActual.direccion;

          // 1. Eliminar la nota
          notas.splice(filaEnEdicion, 1);

          // 2. Re-indexar todas las notas correlativamente (1, 2, 3...)
          // Primero las ordenamos por su orden original para re-indexar bien
          notas.sort((a, b) => a.ordenCaptura - b.ordenCaptura);
          notas.forEach((nota, idx) => {
            nota.ordenCaptura = idx + 1;
          });

          // 3. Actualizar el contador para la siguiente nota
          nextOrdenCaptura = notas.length + 1;

          // 4. Guardar cambios
          guardarNotas();

          // 5. Restaurar la ordenaciÃ³n que tenÃ­a el usuario (si no era por orden de captura)
          // Si era por orden de captura, simplemente re-renderizamos con el nuevo orden
          ordenarTabla(currentCol, true);
          ordenActual.direccion = currentDir; // Mantener la direcciÃ³n original si cambiÃ³ por el "true"
          ordenarTabla(currentCol, false); // Aplicar de nuevo para asegurar direcciÃ³n correcta

          document.querySelector("form").reset();
          resetearEstadoEdicion();
          mostrarMensaje('ðŸ—‘ï¸ Nota eliminada correctamente y numeraciÃ³n actualizada.', 'success');
        }
      }
    }

    function contieneCamposVacios(nota) {
      // Tema es opcional, por eso se filtra aquÃ­
      const camposARevisar = camposDeDatos.filter(c => c !== 'ordenCaptura' && c !== 'tema');
      for (const campo of camposARevisar) {
        if (!nota[campo] || (typeof nota[campo] === 'string' && nota[campo].trim() === '')) {
          return true;
        }
      }
      return false;
    }

    function renderizarTabla() {
      const tablaBody = document.getElementById("tablaNotas").querySelector("tbody");
      tablaBody.innerHTML = '';

      notas.forEach((nota, indice) => {
        const tr = document.createElement("tr");
        tr.dataset.index = notas.indexOf(nota);

        if (contieneCamposVacios(nota)) {
          tr.classList.add('fila-vacia');
        }

        camposDeDatos.forEach(campo => {
          const td = document.createElement("td");
          td.textContent = nota[campo];
          if (!nota[campo] || (typeof nota[campo] === 'string' && nota[campo].trim() === '')) {
            td.classList.add('alerta-vacio');
          }
          td.setAttribute('data-label', encabezadosTabla[campo]);
          tr.appendChild(td);
        });

        const tdAcciones = document.createElement("td");
        tdAcciones.setAttribute('data-label', encabezadosTabla['acciones']);
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar";
        btnEditar.classList.add('btn-accion-tabla');
        btnEditar.onclick = function () { editarNota(tr); };
        tdAcciones.appendChild(btnEditar);
        tr.appendChild(tdAcciones);

        tablaBody.appendChild(tr);
      });

      // Vuelve a aplicar el filtro despuÃ©s de renderizar (Ãºtil para cuando se edita/guarda)
      filtrarTabla();
    }

    function cargarNotasGuardadas() {
      const datosJSON = localStorage.getItem('notasCapturadas');
      const ordenJSON = localStorage.getItem('nextOrdenCaptura');

      if (ordenJSON) nextOrdenCaptura = parseInt(ordenJSON, 10);

      if (datosJSON) {
        try {
          notas = JSON.parse(datosJSON);
          notas.forEach(nota => {
            if (!nota.ordenCaptura) nota.ordenCaptura = nextOrdenCaptura++;
          });
          ordenarTabla(ordenActual.columna, true);
        } catch (e) {
          console.error("Error al cargar notas:", e);
          notas = [];
        }
      } else {
        ordenarTabla(ordenActual.columna, true); // Renderizar tabla vacÃ­a y actualizar iconos
      }
    }

    function alternarBloqueo(idCampo) {
      const campo = document.getElementById(idCampo);
      const checkboxId = `check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`;
      const checkbox = document.getElementById(checkboxId);

      campo.readOnly = checkbox.checked;
      campo.classList.toggle("bloqueado", checkbox.checked);

      localStorage.setItem(`bloqueado_${idCampo}`, checkbox.checked);

      // Mantener el foco en el campo despuÃ©s de alternar el bloqueo
      if (campo && document.activeElement !== campo) {
        campo.focus();
      }
    }

    // --- FUNCIÃ“N DE MENSAJES TOAST ---
    function mostrarMensaje(mensaje, tipo = 'success') {
      const container = document.getElementById('messageContainer');
      const toast = document.createElement('div');
      toast.className = `toast-message ${tipo}`;
      toast.textContent = mensaje;

      container.appendChild(toast);

      // Auto-desaparecer despuÃ©s de 4 segundos
      setTimeout(() => {
        toast.classList.add('hide');
        // Eliminar del DOM despuÃ©s de la transiciÃ³n
        toast.addEventListener('transitionend', () => {
          toast.remove();
        });
      }, 4000);
    }

    function editarNota(tr) {
      const indice = parseInt(tr.dataset.index);
      const nota = notas[indice];

      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        document.getElementById(id).value = nota[id];
      });

      resetearEstadoEdicion();

      document.getElementById("dependencia").dispatchEvent(new Event('blur'));
      document.getElementById("radiodifusora").dispatchEvent(new Event('blur'));

      filaEnEdicion = indice;
      document.getElementById('btnGuardar').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Actualizar Nota';
      document.getElementById('btnEliminar').style.display = 'inline-block';

      document.querySelectorAll('#tablaNotas tbody tr').forEach(row => row.classList.remove('editando'));
      tr.classList.add('editando');
      window.scrollTo(0, 0);
    }

    function generarNombreArchivoCSV() {
      const usuario = document.getElementById('usuario').value.trim() || 'Desconocido';
      const usuarioLimpio = usuario.replace(/\s/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
      const fechaHoy = new Date().toISOString().slice(0, 10);
      return `${usuarioLimpio}_${fechaHoy}.csv`;
    }

    function generarCSVContenido() {
      const cabeceras = ["#", "Usuario", "Fecha", "Radiodifusora", "Titular", "Autor", "Programa", "Dependencia", "Organismo", "GÃ©nero", "Canal", "Tema", "Estatus", "Municipio"];
      const filas = [cabeceras];

      notas.forEach(nota => {
        const fila = camposDeDatos.map(key => {
          let valor = nota[key] || '';
          return `"${valor.toString().replace(/"/g, '""')}"`;
        });
        filas.push(fila);
      });

      return "\uFEFF" + filas.map(f => f.join(",")).join("\n");
    }

    function exportarCSV() {
      if (notas.length === 0) {
        mostrarMensaje("No hay notas para descargar.", 'error');
        return;
      }

      const csvContenido = generarCSVContenido();
      const nombreArchivo = generarNombreArchivoCSV();

      const blob = new Blob([csvContenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombreArchivo;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      mostrarMensaje("CSV descargado con Ã©xito.", 'success');
    }

    // --- FUNCIÃ“N AÃ‘ADIDA: ENVIAR A GOOGLE SHEETS (JSON) ---
    async function enviarSheets() {
      if (notas.length === 0) {
        mostrarMensaje("No hay notas para enviar a Google Sheets.", 'error');
        return;
      }

      const btn = document.getElementById('btnSheets');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';

      try {
        // 1. Prepara los datos como JSON y envÃ­alos en un FormData
        const datosJSON = JSON.stringify(notas);
        const formData = new FormData();
        formData.append("notas", datosJSON);
        formData.append("tipo", "datos_monitoreo");

        const response = await fetch(URL_APP_SCRIPT, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (response.ok && data.result === 'success') {
          mostrarMensaje(`âœ… ${notas.length} notas enviadas a Google Sheets con Ã©xito.`, 'success');
        } else {
          const errorMessage = data.error || data.description || "Error desconocido. Revise su App Script.";
          mostrarMensaje(`âŒ Error al enviar a Sheets: ${errorMessage}`, 'error');
          console.error("Error App Script:", data);
        }

      } catch (e) {
        mostrarMensaje("âŒ Error de red o conexiÃ³n al comunicarse con Google App Script. Revisa la consola.", 'error');
        console.error("Fetch error:", e);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function ordenarTabla(columna, esInicial = false) {
      if (!columna) return;
      let direccion = 'asc';
      if (ordenActual.columna === columna && !esInicial) {
        direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
      } else if (esInicial && columna === 'ordenCaptura') {
        direccion = 'desc';
      }

      notas.sort((a, b) => {
        const valA = a[columna] || '';
        const valB = b[columna] || '';
        let comparacion = 0;

        if (columna === 'ordenCaptura') comparacion = valA - valB;
        else if (columna === 'fecha') {
          const dateA = new Date(valA + 'T00:00:00');
          const dateB = new Date(valB + 'T00:00:00');
          if (dateA < dateB) comparacion = -1;
          if (dateA > dateB) comparacion = 1;
        } else {
          comparacion = valA.toString().localeCompare(valB.toString(), 'es', { sensitivity: 'base' });
        }
        return direccion === 'asc' ? comparacion : -comparacion;
      });

      ordenActual = { columna, direccion };
      actualizarIndicadoresOrden();
      renderizarTabla();
    }

    function actualizarIndicadoresOrden() {
      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
        const headerDiv = th.querySelector('.sortable-header');
        const iconSpan = th.querySelector('.sort-icon');
        const col = th.dataset.col;
        headerDiv.classList.remove('sorted');
        iconSpan.innerHTML = '';
        if (col === ordenActual.columna) {
          headerDiv.classList.add('sorted');
          iconSpan.innerHTML = ordenActual.direccion === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
        } else {
          iconSpan.innerHTML = '<i class="fas fa-sort"></i>';
        }
      });
    }

    // --- FUNCIÃ“N: BÃšSQUEDA EN TIEMPO REAL ---
    function filtrarTabla() {
      const input = document.getElementById('buscador');
      const filtro = input.value.toLowerCase();
      const filas = document.getElementById('tablaNotas').querySelectorAll('tbody tr');

      filas.forEach(tr => {
        let encontrado = false;
        // Itera sobre las celdas (excepto la Ãºltima, que es la de Acciones)
        for (let i = 0; i < tr.cells.length - 1; i++) {
          const textoCelda = tr.cells[i].textContent || tr.cells[i].innerText;
          if (textoCelda.toLowerCase().includes(filtro)) {
            encontrado = true;
            break;
          }
        }
        tr.style.display = encontrado ? "" : "none";
      });
    }

    // --- FUNCIÃ“N CORREGIDA: MOVER EL FOCO AL SIGUIENTE INPUT (INCLUYE BLOQUEADOS) ---
    function focusNextInput(currentElement) {
      const form = currentElement.form;
      if (!form) return;

      // **CORRECCIÃ“N:** Selecciona todos los inputs de texto y fecha, sin excepciÃ³n de [readonly].
      const focusableInputs = Array.from(form.querySelectorAll('input[type="text"], input[type="date"], textarea'));

      const currentIndex = focusableInputs.indexOf(currentElement);
      if (currentIndex > -1 && currentIndex < focusableInputs.length - 1) {
        focusableInputs[currentIndex + 1].focus();
        return true;
      }

      // Si es el Ãºltimo input, intenta enfocar el botÃ³n de guardar
      if (currentIndex === focusableInputs.length - 1) {
        document.getElementById('btnGuardar').focus();
        return true;
      }

      return false;
    }

    // --- FUNCIÃ“N CORREGIDA: MOVER EL FOCO AL ANTERIOR INPUT (INCLUYE BLOQUEADOS) ---
    function focusPrevInput(currentElement) {
      const form = currentElement.form;
      if (!form) return;

      // **CORRECCIÃ“N:** Selecciona todos los inputs de texto y fecha, sin excepciÃ³n de [readonly].
      const focusableInputs = Array.from(form.querySelectorAll('input[type="text"], input[type="date"], textarea'));

      const currentIndex = focusableInputs.indexOf(currentElement);
      if (currentIndex > 0) { // Si no es el primer elemento
        focusableInputs[currentIndex - 1].focus();
        return true;
      }

      return false;
    }

    // --- FUNCIÃ“N HELPER para Enter en inputs sin autocompletado ---
    function handleEnterKey(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        focusNextInput(this);
      }
    }

    // --- Eventos ---
    document.addEventListener("DOMContentLoaded", async () => {
      let orgMap, programaMap;

      const depData = await cargarMapa(urls.dependencias);
      orgMap = depData.map;
      autocompletar("dependencia", "sugDep", depData.claves, dep => {
        autocompletar("organismo", "sugOrg", orgMap[dep] || []);
      });

      const radioData = await cargarMapa(urls.radiodifusoras);
      programaMap = radioData.map;
      autocompletar("radiodifusora", "sugRadiodifusora", radioData.claves, radio => {
        const programas = programaMap[radio] || [];
        autocompletar("programa", "sugPrograma", programas);
        // Si solo hay un programa al seleccionar la radio, lo auto-rellenamos.
        if (programas.length === 1) document.getElementById("programa").value = programas[0];
      });

      // Blur events
      document.getElementById("dependencia").addEventListener("blur", (e) => {
        const val = e.target.value.trim();
        const key = findKeyCaseInsensitive(orgMap, val);
        if (key) { e.target.value = key; autocompletar("organismo", "sugOrg", orgMap[key] || []); }
        else autocompletar("organismo", "sugOrg", []);
      });

      document.getElementById("radiodifusora").addEventListener("blur", (e) => {
        const val = e.target.value.trim();
        const key = findKeyCaseInsensitive(programaMap, val);
        if (key) {
          e.target.value = key;
          const progs = programaMap[key] || [];
          autocompletar("programa", "sugPrograma", progs);
          if (progs.length === 1) document.getElementById("programa").value = progs[0];
        } else {
          autocompletar("programa", "sugPrograma", []);
        }
      });

      // Initialize dependent empty
      autocompletar("organismo", "sugOrg", []);
      autocompletar("programa", "sugPrograma", []);

      autocompletar("genero", "sugGenero", await cargarLista(urls.generos));
      autocompletar("estatus", "sugEstatus", await cargarLista(urls.estatus));
      autocompletar("tema", "sugTema", await cargarLista(urls.temas));
      autocompletar("municipio", "sugMunicipio", await cargarLista(urls.municipios));
      autocompletar("autor", "sugAutor", await cargarLista(urls.autores));
      autocompletar("canal", "sugCanal", await cargarLista("./Canal.csv"));

      // --- Listener para el buscador en tiempo real ---
      document.getElementById('buscador').addEventListener('input', filtrarTabla);

      // --- Agregar listeners de Enter para campos sin autocompletado ---
      document.getElementById('usuario').addEventListener('keydown', handleEnterKey);
      document.getElementById('fecha').addEventListener('keydown', handleEnterKey);
      document.getElementById('titular').addEventListener('keydown', handleEnterKey);


      // Persistence & Locks
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        const campo = document.getElementById(id);
        if (localStorage.getItem(id)) campo.value = localStorage.getItem(id);
        campo.addEventListener("input", () => localStorage.setItem(id, campo.value));

        const chk = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
        if (chk) {
          chk.checked = localStorage.getItem(`bloqueado_${id}`) === 'true';
          alternarBloqueo(id);
        }
      });

      cargarNotasGuardadas();

      document.querySelectorAll('#tablaNotas th[data-col]').forEach(th => {
        th.addEventListener('click', () => ordenarTabla(th.dataset.col));
      });

      // --- CORRECCIÃ“N: Manejo del RESET (BotÃ³n Limpiar) para los estilos de bloqueo ---
      document.querySelector("form").addEventListener('reset', () => {
        setTimeout(() => {
          camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
            const campo = document.getElementById(id);
            const isLocked = localStorage.getItem(`bloqueado_${id}`) === 'true';

            if (!isLocked) {
              // **FIX**: Asegurar que los campos no bloqueados no tengan la clase visual gris
              campo.classList.remove("bloqueado");
              localStorage.removeItem(id); // Limpiar el valor temporal guardado
            } else {
              // Asegurar que los campos bloqueados mantengan el estilo
              campo.classList.add("bloqueado");
            }
          });
          resetearEstadoEdicion();
          const titular = document.getElementById('titular');
          titular.style.height = 'auto'; // Resetear altura
          titular.focus();
        }, 10);
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.campo')) {
          document.querySelectorAll('.sugerencias').forEach(s => s.innerHTML = "");
        }
      });

      // --- Listener global para atajos de teclado ---
      document.addEventListener('keydown', (e) => {
        // Usar e.ctrlKey para Ctrl en Windows/Linux y e.metaKey para Cmd en Mac
        const isCtrlOrCmd = e.ctrlKey || e.metaKey;

        // ATALO PARA BLOQUEAR/DESBLOQUEAR (Ctrl + Shift + L)
        if (isCtrlOrCmd && e.shiftKey && e.key.toLowerCase() === 'l') {
          const activeElement = document.activeElement;
          const tagName = activeElement.tagName.toLowerCase();

          if (((tagName === 'input' && (activeElement.type === 'text' || activeElement.type === 'date')) || tagName === 'textarea') && activeElement.id) {
            e.preventDefault();

            const idCampo = activeElement.id;
            const checkboxId = `check${idCampo.charAt(0).toUpperCase() + idCampo.slice(1)}`;
            const checkbox = document.getElementById(checkboxId);

            if (checkbox) {
              // Simular el clic en el checkbox para alternar el estado
              checkbox.checked = !checkbox.checked;
              alternarBloqueo(idCampo);
            }
          }
        }

        // ATALHO PARA GUARDAR (Ctrl + Q)
        else if (isCtrlOrCmd && e.key.toLowerCase() === 'q') {
          e.preventDefault();
          // Disparar el evento submit del formulario
          const form = document.querySelector("form");
          if (form) {
            form.dispatchEvent(new Event('submit', { cancelable: true }));
          }
        }
      });
    });

    document.querySelector("form").addEventListener("submit", e => {
      e.preventDefault();

      const form = e.currentTarget;

      // Pre-carga de nota para validaciÃ³n
      const nuevaNota = {};
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        if (id === 'titular') {
          nuevaNota[id] = document.getElementById(id).value.trim().replace(/\n/g, ' ');
        } else {
          nuevaNota[id] = document.getElementById(id).value.trim();
        }
      });

      // 1. VALIDACIÃ“N CUSTOM (Mensaje de error si faltan campos)
      if (contieneCamposVacios(nuevaNota)) {
        // Intentar enfocar el primer campo vacÃ­o para guiar al usuario
        const primerCampoVacioId = camposDeDatos.filter(c => c !== 'ordenCaptura' && c !== 'tema').find(id => !nuevaNota[id]);
        if (primerCampoVacioId) {
          document.getElementById(primerCampoVacioId).focus();
        }
        mostrarMensaje('âš ï¸ Por favor, complete todos los campos requeridos (excepto Tema) antes de guardar.', 'error');
        return;
      }

      // 2. Proceso de Guardado
      if (filaEnEdicion !== null) {
        notas[filaEnEdicion] = { ...nuevaNota, ordenCaptura: notas[filaEnEdicion].ordenCaptura };
        resetearEstadoEdicion();
      } else {
        nuevaNota.ordenCaptura = nextOrdenCaptura++;
        notas.push(nuevaNota);
      }

      guardarNotas();
      ordenarTabla(ordenActual.columna, true);

      // 3. Limpiar y enfocar
      camposDeDatos.filter(c => c !== 'ordenCaptura').forEach(id => {
        // Limpiar solo si no estÃ¡ bloqueado
        if (localStorage.getItem(`bloqueado_${id}`) !== 'true') {
          document.getElementById(id).value = '';
          localStorage.removeItem(id);
        }
      });

      // Mover el foco al campo Titular despuÃ©s de guardar
      const titular = document.getElementById('titular');
      titular.style.height = 'auto'; // Resetear altura
      titular.focus();

      // 4. MENSAJE DE Ã‰XITO
      mostrarMensaje('âœ… Nota guardada correctamente.', 'success');
    });
  </script>

  <footer>
    Â© 2025 InstituciÃ³n PÃºblica. Todos los derechos reservados.
  </footer>
</body>

</html>